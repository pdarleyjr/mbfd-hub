console.log("[PushWidget] script loaded");function r(){return{VAPID_PUBLIC_KEY:"",elements:{},sections:{},controls:{},initWidget(){const e=this.$el;this.VAPID_PUBLIC_KEY=e.dataset.vapidKey||"",this.sections={loading:e.querySelector("#push-loading"),iosPrompt:e.querySelector("#ios-prompt"),notSupported:e.querySelector("#not-supported"),permissionDenied:e.querySelector("#permission-denied"),subscribeSection:e.querySelector("#subscribe-section"),subscribedSection:e.querySelector("#subscribed-section"),errorSection:e.querySelector("#error-section")},this.controls={errorMessage:e.querySelector("#error-message"),subscribeBtn:e.querySelector("#subscribe-btn"),unsubscribeBtn:e.querySelector("#unsubscribe-btn"),testNotificationBtn:e.querySelector("#test-notification-btn")},this.elements={...this.sections,...this.controls},this.controls.subscribeBtn&&this.controls.subscribeBtn.addEventListener("click",()=>this.subscribe()),this.controls.unsubscribeBtn&&this.controls.unsubscribeBtn.addEventListener("click",()=>this.unsubscribe()),this.controls.testNotificationBtn&&this.controls.testNotificationBtn.addEventListener("click",()=>this.sendTestNotification()),(async()=>(console.log("[PushWidget] Initializing push notification widget..."),await this.registerServiceWorker(),this.checkStatus()))()},hideAllSections(){Object.values(this.sections).forEach(e=>{e&&e.classList&&e.classList.add("hidden")})},hideAll(){Object.values(this.elements).forEach(e=>{e&&e.classList&&e.classList.add("hidden")})},show(e){e&&e.classList.remove("hidden")},isIOS(){return/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream},isStandalone(){return window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches},urlBase64ToUint8Array(e){const t="=".repeat((4-e.length%4)%4),i=(e+t).replace(/-/g,"+").replace(/_/g,"/"),s=window.atob(i),o=new Uint8Array(s.length);for(let n=0;n<s.length;++n)o[n]=s.charCodeAt(n);return o},async registerServiceWorker(){if("serviceWorker"in navigator)try{console.log("[PushWidget] Attempting to register service worker...");const e=await navigator.serviceWorker.register("/sw.js",{scope:"/"});return console.log("[PushWidget] Service Worker registered successfully with scope:",e.scope),e}catch(e){return console.error("[PushWidget] Service Worker registration failed:",e),null}return console.log("[PushWidget] Service workers are not supported in this browser"),null},async checkStatus(){if(this.hideAllSections(),!("serviceWorker"in navigator)||!("PushManager"in window)){console.log("[PushWidget] Push not supported in this browser"),this.show(this.sections.notSupported);return}if(this.isIOS()&&!this.isStandalone()){console.log("[PushWidget] iOS device not in standalone mode"),this.show(this.sections.iosPrompt);return}if(Notification.permission==="denied"){console.log("[PushWidget] Notification permission denied"),this.show(this.sections.permissionDenied);return}try{console.log("[PushWidget] Checking service worker ready status with 5s timeout...");const e=await Promise.race([navigator.serviceWorker.ready,new Promise((i,s)=>setTimeout(()=>s(new Error("Service worker ready timeout")),5e3))]);console.log("[PushWidget] Service worker ready, checking subscription..."),await e.pushManager.getSubscription()?(console.log("[PushWidget] User is subscribed"),this.show(this.sections.subscribedSection)):(console.log("[PushWidget] User not subscribed, show subscribe button"),this.show(this.sections.subscribeSection))}catch(e){if(console.log("[PushWidget] Service worker not ready or timeout, attempting registration..."),await this.registerServiceWorker()){console.log("[PushWidget] Service worker registered, retrying status check..."),setTimeout(()=>this.checkStatus(),500);return}console.error("[PushWidget] Could not register service worker:",e),this.hideAllSections(),this.show(this.sections.errorSection),this.controls.errorMessage.textContent="Could not register service worker: "+e.message}},async subscribe(){var e;try{if(console.log("[PushWidget] Starting subscription process..."),this.controls.subscribeBtn.disabled=!0,this.controls.subscribeBtn.textContent="Enabling...",Notification.permission==="default"){console.log("[PushWidget] Requesting notification permission...");const o=await Notification.requestPermission();if(console.log("[PushWidget] Permission result:",o),o!=="granted")throw new Error("Notification permission not granted: "+o)}if(Notification.permission!=="granted")throw new Error("Notification permission not granted");const i=await(await navigator.serviceWorker.ready).pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.urlBase64ToUint8Array(this.VAPID_PUBLIC_KEY)});if(console.log("[PushWidget] Push subscription created, sending to server..."),!(await fetch("/api/push-subscriptions",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((e=document.querySelector('meta[name="csrf-token"]'))==null?void 0:e.content)||""},credentials:"same-origin",body:JSON.stringify(i.toJSON())})).ok)throw new Error("Failed to save subscription");console.log("[PushWidget] Subscription saved successfully"),this.hideAllSections(),this.show(this.sections.subscribedSection)}catch(t){console.error("[PushWidget] Subscription error:",t),this.hideAllSections(),this.show(this.sections.errorSection),this.controls.errorMessage.textContent="Failed to enable notifications: "+t.message}finally{this.controls.subscribeBtn&&(this.controls.subscribeBtn.disabled=!1,this.controls.subscribeBtn.textContent="Enable Push Notifications")}},async unsubscribe(){var e;try{console.log("[PushWidget] Unsubscribing...");const i=await(await navigator.serviceWorker.ready).pushManager.getSubscription();i&&(await i.unsubscribe(),console.log("[PushWidget] Unsubscribed locally, notifying server..."),await fetch("/api/push-subscriptions",{method:"DELETE",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((e=document.querySelector('meta[name="csrf-token"]'))==null?void 0:e.content)||""},credentials:"same-origin",body:JSON.stringify({endpoint:i.endpoint})})),console.log("[PushWidget] Unsubscription complete"),this.hideAllSections(),this.show(this.sections.subscribeSection)}catch(t){console.error("[PushWidget] Unsubscribe error:",t)}},async sendTestNotification(){var e;try{console.log("[PushWidget] Sending test notification..."),this.controls.testNotificationBtn&&(this.controls.testNotificationBtn.disabled=!0,this.controls.testNotificationBtn.textContent="Sending...");const i=await(await fetch("/api/push/test",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((e=document.querySelector('meta[name="csrf-token"]'))==null?void 0:e.content)||""},credentials:"same-origin"})).json();i.success?(alert("Test notification sent! Check your device for the notification."),console.log("[PushWidget] Test notification sent successfully")):(alert("Error: "+(i.error||i.message||"Failed to send test notification")),console.error("[PushWidget] Test notification failed:",i))}catch(t){console.error("[PushWidget] Failed to send test notification:",t),alert("Failed to send test notification. Please try again.")}finally{this.controls.testNotificationBtn&&(this.controls.testNotificationBtn.disabled=!1,this.controls.testNotificationBtn.innerHTML=`
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                        </svg>
                        Send Test Notification
                    `)}}}}window.pushNotificationWidget=r;window.sendTestNotification=function(){const e=document.querySelector("#push-notification-manager");if(e&&e._x_dataStack){const t=e._x_dataStack[0];t&&t.sendTestNotification&&t.sendTestNotification()}};
