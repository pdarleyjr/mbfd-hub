{"version":3,"file":"push-notification-widget-CrSmpa9E.js","sources":["../../../resources/js/push-notification-widget.js"],"sourcesContent":["console.log('[PushWidget] script loaded');\n\nfunction pushNotificationWidget() {\n    return {\n        VAPID_PUBLIC_KEY: '',\n        elements: {},\n        sections: {},\n        controls: {},\n\n        initWidget() {\n            const widgetContainer = this.$el;\n            this.VAPID_PUBLIC_KEY = widgetContainer.dataset.vapidKey || '';\n\n            // Cache DOM elements - separate sections from controls\n            this.sections = {\n                loading: widgetContainer.querySelector('#push-loading'),\n                iosPrompt: widgetContainer.querySelector('#ios-prompt'),\n                notSupported: widgetContainer.querySelector('#not-supported'),\n                permissionDenied: widgetContainer.querySelector('#permission-denied'),\n                subscribeSection: widgetContainer.querySelector('#subscribe-section'),\n                subscribedSection: widgetContainer.querySelector('#subscribed-section'),\n                errorSection: widgetContainer.querySelector('#error-section'),\n            };\n\n            this.controls = {\n                errorMessage: widgetContainer.querySelector('#error-message'),\n                subscribeBtn: widgetContainer.querySelector('#subscribe-btn'),\n                unsubscribeBtn: widgetContainer.querySelector('#unsubscribe-btn'),\n                testNotificationBtn: widgetContainer.querySelector('#test-notification-btn'),\n            };\n\n            // Keep elements for backward compatibility\n            this.elements = { ...this.sections, ...this.controls };\n\n            // Setup event listeners\n            if (this.controls.subscribeBtn) {\n                this.controls.subscribeBtn.addEventListener('click', () => this.subscribe());\n            }\n            if (this.controls.unsubscribeBtn) {\n                this.controls.unsubscribeBtn.addEventListener('click', () => this.unsubscribe());\n            }\n            if (this.controls.testNotificationBtn) {\n                this.controls.testNotificationBtn.addEventListener('click', () => this.sendTestNotification());\n            }\n\n            // Initialize - Register service worker first, then check status\n            (async () => {\n                console.log('[PushWidget] Initializing push notification widget...');\n                await this.registerServiceWorker();\n                this.checkStatus();\n            })();\n        },\n\n        hideAllSections() {\n            Object.values(this.sections).forEach(el => {\n                if (el && el.classList) el.classList.add('hidden');\n            });\n        },\n\n        hideAll() {\n            Object.values(this.elements).forEach(el => {\n                if (el && el.classList) el.classList.add('hidden');\n            });\n        },\n\n        show(element) {\n            if (element) element.classList.remove('hidden');\n        },\n\n        isIOS() {\n            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;\n        },\n\n        isStandalone() {\n            return window.navigator.standalone === true ||\n                   window.matchMedia('(display-mode: standalone)').matches;\n        },\n\n        urlBase64ToUint8Array(base64String) {\n            const padding = '='.repeat((4 - base64String.length % 4) % 4);\n            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');\n            const rawData = window.atob(base64);\n            const outputArray = new Uint8Array(rawData.length);\n            for (let i = 0; i < rawData.length; ++i) {\n                outputArray[i] = rawData.charCodeAt(i);\n            }\n            return outputArray;\n        },\n\n        // Service Worker Registration\n        async registerServiceWorker() {\n            if ('serviceWorker' in navigator) {\n                try {\n                    console.log('[PushWidget] Attempting to register service worker...');\n                    const registration = await navigator.serviceWorker.register('/sw.js', { scope: '/' });\n                    console.log('[PushWidget] Service Worker registered successfully with scope:', registration.scope);\n                    return registration;\n                } catch (error) {\n                    console.error('[PushWidget] Service Worker registration failed:', error);\n                    return null;\n                }\n            }\n            console.log('[PushWidget] Service workers are not supported in this browser');\n            return null;\n        },\n\n        async checkStatus() {\n            this.hideAllSections();\n\n            // Check basic support\n            if (!('serviceWorker' in navigator) || !('PushManager' in window)) {\n                console.log('[PushWidget] Push not supported in this browser');\n                this.show(this.sections.notSupported);\n                return;\n            }\n\n            // iOS specific handling\n            if (this.isIOS() && !this.isStandalone()) {\n                console.log('[PushWidget] iOS device not in standalone mode');\n                this.show(this.sections.iosPrompt);\n                return;\n            }\n\n            // Check permission\n            if (Notification.permission === 'denied') {\n                console.log('[PushWidget] Notification permission denied');\n                this.show(this.sections.permissionDenied);\n                return;\n            }\n\n            // Check existing subscription with timeout fallback\n            try {\n                console.log('[PushWidget] Checking service worker ready status with 5s timeout...');\n                // Wait for service worker with 5 second timeout\n                const registration = await Promise.race([\n                    navigator.serviceWorker.ready,\n                    new Promise((_, reject) =>\n                        setTimeout(() => reject(new Error('Service worker ready timeout')), 5000)\n                    )\n                ]);\n\n                console.log('[PushWidget] Service worker ready, checking subscription...');\n                const subscription = await registration.pushManager.getSubscription();\n\n                if (subscription) {\n                    console.log('[PushWidget] User is subscribed');\n                    this.show(this.sections.subscribedSection);\n                } else {\n                    console.log('[PushWidget] User not subscribed, show subscribe button');\n                    this.show(this.sections.subscribeSection);\n                }\n            } catch (error) {\n                console.log('[PushWidget] Service worker not ready or timeout, attempting registration...');\n                // If service worker not registered, register it\n                const newReg = await this.registerServiceWorker();\n                if (newReg) {\n                    // Try again after registration\n                    console.log('[PushWidget] Service worker registered, retrying status check...');\n                    setTimeout(() => this.checkStatus(), 500);\n                    return;\n                }\n                console.error('[PushWidget] Could not register service worker:', error);\n                this.hideAllSections();\n                this.show(this.sections.errorSection);\n                this.controls.errorMessage.textContent = 'Could not register service worker: ' + error.message;\n            }\n        },\n\n        async subscribe() {\n            try {\n                console.log('[PushWidget] Starting subscription process...');\n                this.controls.subscribeBtn.disabled = true;\n                this.controls.subscribeBtn.textContent = 'Enabling...';\n\n                // Request notification permission first (required for iOS and best practice)\n                if (Notification.permission === 'default') {\n                    console.log('[PushWidget] Requesting notification permission...');\n                    const permission = await Notification.requestPermission();\n                    console.log('[PushWidget] Permission result:', permission);\n                    if (permission !== 'granted') {\n                        throw new Error('Notification permission not granted: ' + permission);\n                    }\n                }\n\n                if (Notification.permission !== 'granted') {\n                    throw new Error('Notification permission not granted');\n                }\n\n                const registration = await navigator.serviceWorker.ready;\n\n                const subscription = await registration.pushManager.subscribe({\n                    userVisibleOnly: true,\n                    applicationServerKey: this.urlBase64ToUint8Array(this.VAPID_PUBLIC_KEY)\n                });\n\n                console.log('[PushWidget] Push subscription created, sending to server...');\n\n                // Send to server\n                const response = await fetch('/api/push-subscriptions', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                        'Accept': 'application/json',\n                        'X-CSRF-TOKEN': document.querySelector('meta[name=\"csrf-token\"]')?.content || ''\n                    },\n                    credentials: 'same-origin',\n                    body: JSON.stringify(subscription.toJSON())\n                });\n\n                if (!response.ok) {\n                    throw new Error('Failed to save subscription');\n                }\n\n                console.log('[PushWidget] Subscription saved successfully');\n                this.hideAllSections();\n                this.show(this.sections.subscribedSection);\n            } catch (error) {\n                console.error('[PushWidget] Subscription error:', error);\n                this.hideAllSections();\n                this.show(this.sections.errorSection);\n                this.controls.errorMessage.textContent = 'Failed to enable notifications: ' + error.message;\n            } finally {\n                if (this.controls.subscribeBtn) {\n                    this.controls.subscribeBtn.disabled = false;\n                    this.controls.subscribeBtn.textContent = 'Enable Push Notifications';\n                }\n            }\n        },\n\n        async unsubscribe() {\n            try {\n                console.log('[PushWidget] Unsubscribing...');\n                const registration = await navigator.serviceWorker.ready;\n                const subscription = await registration.pushManager.getSubscription();\n\n                if (subscription) {\n                    await subscription.unsubscribe();\n                    console.log('[PushWidget] Unsubscribed locally, notifying server...');\n\n                    // Notify server\n                    await fetch('/api/push-subscriptions', {\n                        method: 'DELETE',\n                        headers: {\n                            'Content-Type': 'application/json',\n                            'Accept': 'application/json',\n                            'X-CSRF-TOKEN': document.querySelector('meta[name=\"csrf-token\"]')?.content || ''\n                        },\n                        credentials: 'same-origin',\n                        body: JSON.stringify({ endpoint: subscription.endpoint })\n                    });\n                }\n\n                console.log('[PushWidget] Unsubscription complete');\n                this.hideAllSections();\n                this.show(this.sections.subscribeSection);\n            } catch (error) {\n                console.error('[PushWidget] Unsubscribe error:', error);\n            }\n        },\n\n        async sendTestNotification() {\n            try {\n                console.log('[PushWidget] Sending test notification...');\n                if (this.controls.testNotificationBtn) {\n                    this.controls.testNotificationBtn.disabled = true;\n                    this.controls.testNotificationBtn.textContent = 'Sending...';\n                }\n\n                const response = await fetch('/api/push/test', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                        'Accept': 'application/json',\n                        'X-CSRF-TOKEN': document.querySelector('meta[name=\"csrf-token\"]')?.content || ''\n                    },\n                    credentials: 'same-origin'\n                });\n\n                const data = await response.json();\n                \n                if (data.success) {\n                    alert('Test notification sent! Check your device for the notification.');\n                    console.log('[PushWidget] Test notification sent successfully');\n                } else {\n                    alert('Error: ' + (data.error || data.message || 'Failed to send test notification'));\n                    console.error('[PushWidget] Test notification failed:', data);\n                }\n            } catch (error) {\n                console.error('[PushWidget] Failed to send test notification:', error);\n                alert('Failed to send test notification. Please try again.');\n            } finally {\n                if (this.controls.testNotificationBtn) {\n                    this.controls.testNotificationBtn.disabled = false;\n                    this.controls.testNotificationBtn.innerHTML = `\n                        <svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9\"></path>\n                        </svg>\n                        Send Test Notification\n                    `;\n                }\n            }\n        }\n    };\n}\n\n// Export to global scope for Alpine.js\nwindow.pushNotificationWidget = pushNotificationWidget;\n\n// Also export sendTestNotification to global scope for onclick handler\nwindow.sendTestNotification = function() {\n    const widget = document.querySelector('#push-notification-manager');\n    if (widget && widget._x_dataStack) {\n        const widgetData = widget._x_dataStack[0];\n        if (widgetData && widgetData.sendTestNotification) {\n            widgetData.sendTestNotification();\n        }\n    }\n};\n"],"names":["pushNotificationWidget","widgetContainer","el","element","base64String","padding","base64","rawData","outputArray","i","registration","error","_","reject","_a","permission","subscription","data","widget","widgetData"],"mappings":"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"}