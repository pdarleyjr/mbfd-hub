{"version":3,"file":"receipt-nVCul5S8.js","sources":["../../src/lib/receipt.ts"],"sourcesContent":["/**\r\n * Receipt generation and hosting utilities\r\n */\r\n\r\nimport type { InspectionSubmission } from '../types';\r\n\r\nconst API_BASE_URL = 'https://mbfd-github-proxy.pdarleyjr.workers.dev/api';\r\n\r\nexport interface ReceiptItem {\r\n  compartment?: string;\r\n  itemName: string;\r\n  status: 'present' | 'missing' | 'damaged';\r\n  notes?: string;\r\n}\r\n\r\nexport interface ReceiptPayload {\r\n  inspector: string;\r\n  apparatus: string;\r\n  date: string; // ISO format\r\n  items: ReceiptItem[];\r\n  summary?: {\r\n    totalItems?: number;\r\n    issuesFound?: number;\r\n  };\r\n}\r\n\r\nexport interface ReceiptResponse {\r\n  ok: boolean;\r\n  id: string;\r\n  url: string;\r\n}\r\n\r\n/**\r\n * Build receipt payload from inspection submission data\r\n */\r\nexport function buildReceiptPayloadFromInspection(\r\n  submission: InspectionSubmission\r\n): ReceiptPayload {\r\n  const { user, apparatus, date, items, defects } = submission;\r\n\r\n  // Build a map of item names to compartments for lookup\r\n  // For now, we'll use defects which already have compartment info\r\n  // and items without compartments will show as N/A\r\n  const defectCompartmentMap = new Map<string, string>();\r\n  defects.forEach(d => {\r\n    defectCompartmentMap.set(d.item, d.compartment);\r\n  });\r\n\r\n  const receiptItems: ReceiptItem[] = items.map(item => ({\r\n    compartment: defectCompartmentMap.get(item.name) || undefined,\r\n    itemName: item.name,\r\n    status: item.status || 'present',\r\n    notes: item.notes,\r\n  }));\r\n\r\n  const issuesFound = receiptItems.filter(i => i.status !== 'present').length;\r\n\r\n  return {\r\n    inspector: `${user.name} (${user.rank})`,\r\n    apparatus,\r\n    date,\r\n    items: receiptItems,\r\n    summary: {\r\n      totalItems: items.length,\r\n      issuesFound,\r\n    },\r\n  };\r\n}\r\n\r\n/**\r\n * Create a hosted receipt by POSTing to the worker\r\n * @throws Error if receipt creation fails\r\n */\r\nexport async function createHostedReceipt(\r\n  apiBase: string,\r\n  payload: ReceiptPayload,\r\n  adminPassword?: string\r\n): Promise<ReceiptResponse> {\r\n  const headers: HeadersInit = {\r\n    'Content-Type': 'application/json',\r\n  };\r\n\r\n  if (adminPassword) {\r\n    headers['X-Admin-Password'] = adminPassword;\r\n  }\r\n\r\n  const response = await fetch(`${apiBase}/receipts`, {\r\n    method: 'POST',\r\n    headers,\r\n    body: JSON.stringify(payload),\r\n  });\r\n\r\n  if (!response.ok) {\r\n    const errorData = await response.json().catch(() => ({ message: 'Unknown error' }));\r\n    throw new Error(\r\n      `Failed to create receipt: ${response.status} ${errorData.message || response.statusText}`\r\n    );\r\n  }\r\n\r\n  return await response.json();\r\n}\r\n\r\n/**\r\n * Build a fallback Markdown receipt for embedding in GitHub issues\r\n * Used when hosted receipt creation fails\r\n */\r\nexport function buildReceiptMarkdown(payload: ReceiptPayload): string {\r\n  const { inspector, apparatus, date, items, summary } = payload;\r\n  const dateFormatted = new Date(date).toLocaleString('en-US', {\r\n    dateStyle: 'full',\r\n    timeStyle: 'short',\r\n  });\r\n\r\n  const totalItems = summary?.totalItems ?? items.length;\r\n  const issuesFound = summary?.issuesFound ?? items.filter(i => i.status !== 'present').length;\r\n\r\n  const itemsMarkdown = items\r\n    .map(item => {\r\n      const statusEmoji =\r\n        item.status === 'present' ? '‚úÖ' : item.status === 'missing' ? '‚ùå' : '‚ö†Ô∏è';\r\n      const statusText =\r\n        item.status === 'present' ? 'Present' : item.status === 'missing' ? 'Missing' : 'Damaged';\r\n\r\n      return `- **${item.compartment || 'N/A'}**: ${item.itemName} - ${statusEmoji} ${statusText}${item.notes ? ` (_${item.notes}_)` : ''}`;\r\n    })\r\n    .join('\\n');\r\n\r\n  return `\r\n## üöí Inspection Receipt\r\n\r\n**Apparatus:** ${apparatus}  \r\n**Inspector:** ${inspector}  \r\n**Date:** ${dateFormatted}\r\n\r\n### üìä Summary\r\n- **Items Checked:** ${totalItems}\r\n- **Issues Found:** ${issuesFound}\r\n\r\n### Inspection Details\r\n${itemsMarkdown}\r\n\r\n---\r\n_This receipt was embedded as a fallback. Hosted receipt creation was unavailable._\r\n`.trim();\r\n}\r\n\r\n/**\r\n * Helper to get the admin password from the github service or local storage\r\n * This mimics the pattern used in github.ts\r\n */\r\nexport function getAdminPasswordHeader(): string | undefined {\r\n  // This should ideally come from the github service singleton\r\n  // For now, we'll rely on callers providing it explicitly\r\n  return undefined;\r\n}\r\n\r\n/**\r\n * Convenience function to create a receipt for a submission\r\n * Returns the receipt URL or null if creation failed\r\n */\r\nexport async function tryCreateReceipt(\r\n  submission: InspectionSubmission,\r\n  adminPassword?: string\r\n): Promise<string | null> {\r\n  try {\r\n    const payload = buildReceiptPayloadFromInspection(submission);\r\n    const response = await createHostedReceipt(API_BASE_URL, payload, adminPassword);\r\n    console.log(`Created hosted receipt: ${response.url}`);\r\n    return response.url;\r\n  } catch (error) {\r\n    console.error('Failed to create hosted receipt:', error);\r\n    return null;\r\n  }\r\n}\r\n"],"names":["buildReceiptPayloadFromInspection","submission","user","apparatus","date","items","defects","defectCompartmentMap","d","receiptItems","item","issuesFound","i","createHostedReceipt","apiBase","payload","adminPassword","headers","response","errorData","buildReceiptMarkdown","inspector","summary","dateFormatted","totalItems","itemsMarkdown","statusEmoji","statusText"],"mappings":"AAmCO,SAASA,EACdC,EACgB,CAChB,KAAM,CAAE,KAAAC,EAAM,UAAAC,EAAW,KAAAC,EAAM,MAAAC,EAAO,QAAAC,GAAYL,EAK5CM,MAA2B,IACjCD,EAAQ,QAAQE,GAAK,CACnBD,EAAqB,IAAIC,EAAE,KAAMA,EAAE,WAAW,CAChD,CAAC,EAED,MAAMC,EAA8BJ,EAAM,IAAIK,IAAS,CACrD,YAAaH,EAAqB,IAAIG,EAAK,IAAI,GAAK,OACpD,SAAUA,EAAK,KACf,OAAQA,EAAK,QAAU,UACvB,MAAOA,EAAK,KAAA,EACZ,EAEIC,EAAcF,EAAa,UAAYG,EAAE,SAAW,SAAS,EAAE,OAErE,MAAO,CACL,UAAW,GAAGV,EAAK,IAAI,KAAKA,EAAK,IAAI,IACrC,UAAAC,EACA,KAAAC,EACA,MAAOK,EACP,QAAS,CACP,WAAYJ,EAAM,OAClB,YAAAM,CAAA,CACF,CAEJ,CAMA,eAAsBE,EACpBC,EACAC,EACAC,EAC0B,CAC1B,MAAMC,EAAuB,CAC3B,eAAgB,kBAAA,EAGdD,IACFC,EAAQ,kBAAkB,EAAID,GAGhC,MAAME,EAAW,MAAM,MAAM,GAAGJ,CAAO,YAAa,CAClD,OAAQ,OACR,QAAAG,EACA,KAAM,KAAK,UAAUF,CAAO,CAAA,CAC7B,EAED,GAAI,CAACG,EAAS,GAAI,CAChB,MAAMC,EAAY,MAAMD,EAAS,KAAA,EAAO,MAAM,KAAO,CAAE,QAAS,eAAA,EAAkB,EAClF,MAAM,IAAI,MACR,6BAA6BA,EAAS,MAAM,IAAIC,EAAU,SAAWD,EAAS,UAAU,EAAA,CAE5F,CAEA,OAAO,MAAMA,EAAS,KAAA,CACxB,CAMO,SAASE,EAAqBL,EAAiC,CACpE,KAAM,CAAE,UAAAM,EAAW,UAAAlB,EAAW,KAAAC,EAAM,MAAAC,EAAO,QAAAiB,GAAYP,EACjDQ,EAAgB,IAAI,KAAKnB,CAAI,EAAE,eAAe,QAAS,CAC3D,UAAW,OACX,UAAW,OAAA,CACZ,EAEKoB,EAAaF,GAAS,YAAcjB,EAAM,OAC1CM,EAAcW,GAAS,aAAejB,EAAM,OAAOO,GAAKA,EAAE,SAAW,SAAS,EAAE,OAEhFa,EAAgBpB,EACnB,IAAIK,GAAQ,CACX,MAAMgB,EACJhB,EAAK,SAAW,UAAY,IAAMA,EAAK,SAAW,UAAY,IAAM,KAChEiB,EACJjB,EAAK,SAAW,UAAY,UAAYA,EAAK,SAAW,UAAY,UAAY,UAElF,MAAO,OAAOA,EAAK,aAAe,KAAK,OAAOA,EAAK,QAAQ,MAAMgB,CAAW,IAAIC,CAAU,GAAGjB,EAAK,MAAQ,MAAMA,EAAK,KAAK,KAAO,EAAE,EACrI,CAAC,EACA,KAAK;AAAA,CAAI,EAEZ,MAAO;AAAA;AAAA;AAAA,iBAGQP,CAAS;AAAA,iBACTkB,CAAS;AAAA,YACdE,CAAa;AAAA;AAAA;AAAA,uBAGFC,CAAU;AAAA,sBACXb,CAAW;AAAA;AAAA;AAAA,EAG/Bc,CAAa;AAAA;AAAA;AAAA;AAAA,EAIb,KAAA,CACF"}