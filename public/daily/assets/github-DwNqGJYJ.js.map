{"version":3,"mappings":"8IASA,MAAMA,EAAa,CACjB,CAAC,OAAQ,CAAE,EAAG,SAAU,IAAK,QAAQ,CAAE,EACvC,CAAC,OAAQ,CAAE,EAAG,UAAW,IAAK,QAAQ,CAAE,EACxC,CAAC,OAAQ,CAAE,MAAO,KAAM,OAAQ,KAAM,EAAG,IAAK,EAAG,IAAK,GAAI,IAAK,IAAK,QAAQ,CAAE,EAC9E,CAAC,OAAQ,CAAE,EAAG,WAAY,IAAK,QAAQ,CAAE,CAC3C,EACMC,EAAWC,EAAiB,WAAYF,CAAU,ECNxD,MAAMA,EAAa,CAAC,CAAC,OAAQ,CAAE,EAAG,kBAAmB,IAAK,QAAQ,CAAE,CAAC,EAC/DG,EAAQD,EAAiB,QAASF,CAAU,ECDlD,MAAMA,EAAa,CACjB,CAAC,OAAQ,CAAE,EAAG,kCAAmC,IAAK,QAAQ,CAAE,EAChE,CAAC,OAAQ,CAAE,EAAG,iBAAkB,IAAK,QAAQ,CAAE,CACjD,EACMI,EAAiBF,EAAiB,mBAAoBF,CAAU,ECJtE,MAAMA,EAAa,CACjB,CACE,OACA,CACE,EAAG,2EACH,IAAK,QACX,CACA,EACE,CAAC,OAAQ,CAAE,EAAG,UAAW,IAAK,QAAQ,CAAE,EACxC,CAAC,OAAQ,CAAE,EAAG,aAAc,IAAK,QAAQ,CAAE,CAC7C,EACMK,EAAgBH,EAAiB,iBAAkBF,CAAU,ECXnE,MAAMA,EAAa,CACjB,CAAC,OAAQ,CAAE,EAAG,WAAY,IAAK,QAAQ,CAAE,EACzC,CAAC,OAAQ,CAAE,EAAG,gBAAiB,IAAK,QAAQ,CAAE,EAC9C,CAAC,OAAQ,CAAE,EAAG,4CAA6C,IAAK,QAAQ,CAAE,CAC5E,EACMM,EAASJ,EAAiB,SAAUF,CAAU,ECLpD,MAAMA,EAAa,CACjB,CAAC,OAAQ,CAAE,EAAG,aAAc,IAAK,QAAQ,CAAE,EAC3C,CAAC,OAAQ,CAAE,EAAG,aAAc,IAAK,QAAQ,CAAE,CAC7C,EACMO,EAAIL,EAAiB,IAAKF,CAAU,ECD7BQ,EAA8B,CAAC,CAC1C,OAAAC,EACA,QAAAC,EACA,MAAAC,EACA,SAAAC,EACA,UAAAC,CACF,KACEC,YAAU,KACJL,EACF,SAAS,KAAK,MAAM,SAAW,SAE/B,SAAS,KAAK,MAAM,SAAW,QAG1B,IAAM,CACX,SAAS,KAAK,MAAM,SAAW,OACjC,GACC,CAACA,CAAM,CAAC,EAENA,EAGHM,OAAC,OAAI,UAAU,sDAEb,UAAAC,MAAC,OACC,UAAU,gDACV,QAASN,CAAA,GAIXK,OAAC,OACC,UAAWE,EACT,6FACAJ,CAAA,EAIF,UAAAE,OAAC,OAAI,UAAU,uEACb,UAAAC,MAAC,MAAG,UAAU,sCAAuC,SAAAL,EAAM,EAC3DK,MAAC,UACC,QAASN,EACT,UAAU,qDAEV,SAAAM,MAACT,EAAA,CAAE,UAAU,wBAAwB,GACvC,EACF,EAGAS,MAAC,OAAI,UAAU,YAAa,SAAAJ,CAAA,CAAS,IACvC,EACF,EA/BkB,MC5BtB,MAAMM,CAAc,CACV,cAA+B,KAEvC,aAAc,CAEd,CAKA,iBAAiBC,EAAwB,CACvC,KAAK,cAAgBA,CACvB,CAKA,oBAA2B,CACzB,KAAK,cAAgB,IACvB,CAKA,sBAAgC,CAC9B,OAAO,KAAK,gBAAkB,IAChC,CAKQ,WAAWC,EAAmB,GAAoB,CACxD,MAAMC,EAAuB,CAC3B,eAAgB,oBAGlB,OAAID,GAAW,KAAK,gBAClBC,EAAQ,kBAAkB,EAAI,KAAK,eAG9BA,CACT,CAMA,MAAM,qBAAqBC,EAAsD,CAC/E,GAAI,CACF,MAAMC,EAAW,MAAM,MACrB,GAAGC,CAAY,6BAA6BC,EAAO,MAAM,IAAI,mBAAmBH,CAAS,CAAC,gBAC1F,CACE,OAAQ,MACR,QAAS,KAAK,YAAW,CAC3B,EAGF,GAAI,CAACC,EAAS,GACZ,eAAQ,KAAK,4BAA4BA,EAAS,UAAU,EAAE,MAEnD,IAGb,MAAMG,EAAO,MAAMH,EAAS,OAGtBI,EAAwB,MAAM,QAAQD,CAAI,EAAIA,EAAO,GACrDE,MAAgB,IAEtB,UAAWC,KAASF,EAAQ,CAE1B,MAAMG,EAAQD,EAAM,MAAM,MAAME,CAAkB,EAClD,GAAID,EAAO,CACT,KAAM,GAAKE,EAAaC,CAAI,EAAIH,EAC1BI,EAAM,GAAGF,CAAW,IAAIC,CAAI,GAClCL,EAAU,IAAIM,EAAKL,CAAK,CAC1B,CACF,CAEA,OAAOD,CACT,OAASO,EAAO,CACd,eAAQ,MAAM,mCAAoCA,CAAK,MAE5C,GACb,CACF,CAOA,MAAM,gBAAgBC,EAAiD,CACrE,KAAM,CAAE,KAAAC,EAAM,UAAAf,EAAW,KAAAgB,EAAM,QAAAC,GAAYH,EAGrCI,EAAkB,MAAM,KAAK,qBAAqBlB,CAAS,EAGjE,IAAImB,EAAe,EACnB,MAAMC,EAA0B,GAGhC,UAAWC,KAAUJ,EACnB,GAAI,CACF,MAAMK,EAAY,GAAGD,EAAO,WAAW,IAAIA,EAAO,IAAI,GAChDE,EAAgBL,EAAgB,IAAII,CAAS,EAE/CC,EAEF,MAAM,KAAK,mBACTA,EAAc,OACdR,EAAK,KACLA,EAAK,KACLC,EACAK,EAAO,MACPA,EAAO,UAIT,MAAM,KAAK,kBACTrB,EACAqB,EAAO,YACPA,EAAO,KACPA,EAAO,OACPA,EAAO,MACPN,EAAK,KACLA,EAAK,KACLC,EACAK,EAAO,SAGb,OAASR,EAAO,CACdM,IACA,MAAMK,EAAW,GAAGH,EAAO,WAAW,IAAIA,EAAO,IAAI,GACrDD,EAAc,KAAKI,CAAQ,EAC3B,QAAQ,MAAM,4BAA4BA,CAAQ,IAAKX,CAAK,CAE9D,CAKF,GAAIM,EAAe,EACjB,MAAM,IAAI,MAAM,oBAAoBA,CAAY,eAAeC,EAAc,KAAK,IAAI,CAAC,qBAAqB,EAO9G,GAHA,MAAM,KAAK,eAAeN,CAAU,EAGhCG,EAAQ,OAAS,EACnB,GAAI,CACF,MAAM,KAAK,4BAA4BA,EAASjB,CAAS,CAC3D,OAASa,EAAO,CACd,QAAQ,MAAM,6CAA8CA,CAAK,CAEnE,CAEJ,CAKA,MAAc,kBACZb,EACAU,EACAC,EACAc,EACAC,EACAC,EACAC,EACAZ,EACAa,EACe,CACf,MAAMxC,EAAQ,IAAIW,CAAS,KAAKU,CAAW,KAAKC,CAAI,MAAMc,IAAW,UAAY,UAAY,SAAS,GACtG,IAAIK,EAAO;AAAA;;AAAA,iBAGE9B,CAAS;AAAA,mBACPU,CAAW;AAAA,YAClBC,CAAI;AAAA,cACFc,IAAW,UAAY,YAAc,YAAY;AAAA,mBAC5CE,CAAU,KAAKC,CAAI;AAAA,YAC1BZ,CAAI;;AAAA;AAAA,EAGdU,CAAK;AAAA,EAICG,IACFC,GAAQ;AAAA;;AAAA,kBAA2CD,CAAQ;AAAA,GAG7DC,GAAQ;AAAA;AAAA,qEAGRA,EAAOA,EAAK,OAEZ,MAAMC,EAAS,CAAC5B,EAAO,OAAQH,CAAS,EACpCyB,IAAW,WACbM,EAAO,KAAK5B,EAAO,OAAO,EAG5B,GAAI,CACF,MAAMF,EAAW,MAAM,MAAM,GAAGC,CAAY,UAAW,CACrD,OAAQ,OACR,QAAS,KAAK,aACd,KAAM,KAAK,UAAU,CAAE,MAAAb,EAAO,KAAAyC,EAAM,OAAAC,EAAQ,EAC7C,EAED,GAAI,CAAC9B,EAAS,GACZ,MAAM,IAAI,MAAM,2BAA2BA,EAAS,UAAU,EAAE,CAEpE,OAASY,EAAO,CACd,cAAQ,MAAM,+BAAgCA,CAAK,EAC7CA,CACR,CACF,CAKA,MAAc,mBACZmB,EACAC,EACAL,EACAZ,EACAU,EACAG,EACe,CACf,IAAIC,EAAO;AAAA;;AAAA,iCAGkBG,CAAU,KAAKL,CAAI;AAAA,YACxCZ,CAAI;;AAAA,EAEdU,EAAQ,yBAAyBA,CAAK,GAAK,EAAE;AAAA,EAIvCG,IACFC,GAAQ;AAAA;;AAAA,kBAA2CD,CAAQ;AAAA,GAG7DC,GAAQ;AAAA;AAAA,qEAGRA,EAAOA,EAAK,OAEZ,GAAI,CACF,MAAM7B,EAAW,MAAM,MAAM,GAAGC,CAAY,WAAW8B,CAAW,YAAa,CAC7E,OAAQ,OACR,QAAS,KAAK,aACd,KAAM,KAAK,UAAU,CAAE,KAAAF,EAAM,EAC9B,EAED,GAAI,CAAC7B,EAAS,GACZ,MAAM,IAAI,MAAM,0BAA0BA,EAAS,UAAU,EAAE,CAEnE,OAASY,EAAO,CACd,cAAQ,MAAM,iCAAkCA,CAAK,EAC/CA,CACR,CACF,CAKA,MAAc,eAAeC,EAAiD,CAC5E,KAAM,CAAE,KAAAC,EAAM,UAAAf,EAAW,KAAAgB,EAAM,MAAAkB,GAAUpB,EAEnCzB,EAAQ,IAAIW,CAAS,wBAAwBgB,CAAI,GAGvD,IAAImB,EAA4B,KAC5BC,EAAmB,GAEvB,GAAI,CAEF,KAAM,CAAE,kCAAAC,EAAmC,oBAAAC,EAAqB,qBAAAC,GAAyB,MAAAC,EAAA,kDAAAH,EAAA,oBAAAC,EAAA,qBAAAC,CAAA,OAAM,QAAO,uBAAW,2CAAAF,EAAA,oBAAAC,EAAA,qBAAAC,CAAA,OAC3GE,EAAiBJ,EAAkCvB,CAAU,EAGnE,GAAI,CAEFqB,GADiB,MAAMG,EAAoBpC,EAAcuC,EAAgB,KAAK,eAAiB,MAAS,GAClF,IACtB,QAAQ,IAAI,2BAA2BN,CAAU,EAAE,CACrD,OAASO,EAAc,CACrB,QAAQ,MAAM,mDAAoDA,CAAY,EAE9EN,EAAmBG,EAAqBE,CAAc,CACxD,CACF,OAAS5B,EAAO,CACd,QAAQ,MAAM,gCAAiCA,CAAK,CAEtD,CAGA,IAAIiB,EAAO;AAAA;;AAAA,iBAGE9B,CAAS;AAAA,oBACNe,EAAK,IAAI,KAAKA,EAAK,IAAI;AAAA,YAC/BC,CAAI;;AAAA;AAAA,6BAGakB,EAAM,MAAM;AAAA,sBACnBpB,EAAW,QAAQ,MAAM;;AAAA,EAE7CA,EAAW,QAAQ,OAAS,EAAI;AAAA;AAAA,EAEhCA,EAAW,QAAQ,IAAI6B,GAAK,KAAKA,EAAE,WAAW,KAAKA,EAAE,IAAI,MAAMA,EAAE,SAAW,UAAY,YAAc,YAAY,EAAE,EAAE,KAAK;AAAA,CAAI,CAAC,GAC/H,iCAAiC;AAAA,EAI5BR,EACFL,GAAQ;;AAAA;;AAAA,qCAAiDK,CAAU;;AAAA;AAAA,EAC1DC,IACTN,GAAQ;;AAAA;;AAAA,EAAcM,CAAgB;AAAA,GAGxCN,GAAQ;AAAA;AAAA,8EAGRA,EAAOA,EAAK,OAEZ,GAAI,CACF,MAAM7B,EAAW,MAAM,MAAM,GAAGC,CAAY,UAAW,CACrD,OAAQ,OACR,QAAS,KAAK,aACd,KAAM,KAAK,UAAU,CACnB,MAAAb,EACA,KAAAyC,EACA,OAAQ,CAAC3B,EAAO,IAAKH,CAAS,EAC/B,EACF,EAED,GAAI,CAACC,EAAS,GACZ,MAAM,IAAI,MAAM,yBAAyBA,EAAS,UAAU,EAAE,EAGhE,MAAMM,EAAQ,MAAMN,EAAS,OAGvB2C,EAAgB,MAAM,MAAM,GAAG1C,CAAY,WAAWK,EAAM,MAAM,GAAI,CAC1E,OAAQ,QACR,QAAS,KAAK,aACd,KAAM,KAAK,UAAU,CAAE,MAAO,SAAU,EACzC,EAED,GAAKqC,EAAc,GAqBjB,QAAQ,IAAI,8CAA8CrC,EAAM,MAAM,EAAE,MArBnD,CAErB,MAAMsC,EAAY,MAAMD,EAAc,OACtC,IAAIE,EACJ,GAAI,CACFA,EAAY,KAAK,MAAMD,CAAS,CAClC,MAAY,CACVC,EAAY,CAAE,QAASD,CAAA,CACzB,CAEA,QAAQ,MAAM,8BAA8BtC,EAAM,MAAM,IAAK,CAC3D,OAAQqC,EAAc,OACtB,WAAYA,EAAc,WAC1B,MAAOE,EACP,QAASA,EAAU,SAAW,gBAC/B,EAID,QAAQ,KAAK,+BAA+BvC,EAAM,MAAM,sFAAsF,CAChJ,CAGF,OAASM,EAAO,CACd,cAAQ,MAAM,4BAA6BA,CAAK,EAC1CA,CACR,CACF,CAKA,MAAM,eAAmC,CACvC,GAAI,CACF,MAAMZ,EAAW,MAAM,MACrB,GAAGC,CAAY,6BAA6BC,EAAO,MAAM,gBACzD,CACE,OAAQ,MACR,QAAS,KAAK,WAAW,EAAI,EAC/B,EAGF,GAAI,CAACF,EAAS,GACZ,MAAIA,EAAS,SAAW,IAChB,IAAI,MAAM,gDAAgD,EAE5D,IAAI,MAAM,4BAA4BA,EAAS,UAAU,EAAE,EAGnE,MAAMG,EAAO,MAAMH,EAAS,OAI5B,OAD8B,MAAM,QAAQG,CAAI,EAAIA,EAAO,IAC7C,IAAIG,GAAS,KAAK,qBAAqBA,CAAK,CAAC,CAC7D,OAASM,EAAO,CACd,cAAQ,MAAM,8BAA+BA,CAAK,EAC5CA,CACR,CACF,CAKQ,qBAAqBN,EAA4B,CACvD,MAAMC,EAAQD,EAAM,MAAM,MAAME,CAAkB,EAElD,IAAIT,EAAY,WACZU,EAAc,UACdC,EAAO,UACPc,EAAgC,UAEhCjB,IACFR,EAAYQ,EAAM,CAAC,EACnBE,EAAcF,EAAM,CAAC,EACrBG,EAAOH,EAAM,CAAC,EAEdiB,EADkBjB,EAAM,CAAC,EACN,eAIrB,IAAIqB,EACJ,GAAItB,EAAM,KAAM,CAEd,MAAMwC,EAAaxC,EAAM,KAAK,MAAM,iCAAiC,EACjEwC,IACFlB,EAAWkB,EAAW,CAAC,EAE3B,CAEA,MAAO,CACL,YAAaxC,EAAM,OACnB,UAAAP,EACA,YAAAU,EACA,KAAAC,EACA,OAAAc,EACA,MAAOlB,EAAM,MAAQ,GACrB,WAAYA,EAAM,MAAM,OAAS,UACjC,WAAYA,EAAM,WAClB,UAAWA,EAAM,WACjB,SAAU,GACV,SAAAsB,CAAA,CAEJ,CAKA,MAAM,cAAcG,EAAqBgB,EAAwBC,EAAmC,CAClG,GAAI,CAEF,MAAMC,EAAgB,MAAM,MAAM,GAAGhD,CAAY,WAAW8B,CAAW,GAAI,CACzE,OAAQ,MACR,QAAS,KAAK,WAAW,EAAI,EAC9B,EAED,GAAI,CAACkB,EAAc,GACjB,MAAM,IAAI,MAAM,kCAAkCA,EAAc,UAAU,EAAE,EAO9E,MAAMC,GAJQ,MAAMD,EAAc,QACN,OAAO,IAAKE,GAAeA,EAAM,IAAI,EAG5B,KAAMA,GACzCC,EAAe,SAASD,CAAY,GAEhCE,EAAY,CAACnD,EAAO,OAAQA,EAAO,QAAQ,EAC7CgD,GACFG,EAAU,KAAKH,CAAc,EAI/B,MAAM,MAAM,GAAGjD,CAAY,WAAW8B,CAAW,YAAa,CAC5D,OAAQ,OACR,QAAS,KAAK,WAAW,EAAI,EAC7B,KAAM,KAAK,UAAU,CACnB,KAAM;AAAA;;AAAA,mBAGGiB,CAAU;AAAA,YACjB,IAAI,OAAO,aAAa;;AAAA;AAAA,EAGlCD,CAAc;;AAAA;AAAA;AAAA,EAId,MAAK,CACE,EACF,EAGD,MAAM/C,EAAW,MAAM,MAAM,GAAGC,CAAY,WAAW8B,CAAW,GAAI,CACpE,OAAQ,QACR,QAAS,KAAK,WAAW,EAAI,EAC7B,KAAM,KAAK,UAAU,CACnB,MAAO,SACP,OAAQsB,CAAA,CACT,EACF,EAED,GAAI,CAACrD,EAAS,GACZ,MAAIA,EAAS,SAAW,IAChB,IAAI,MAAM,gDAAgD,EAE5D,IAAI,MAAM,6BAA6BA,EAAS,UAAU,EAAE,CAEtE,OAASY,EAAO,CACd,cAAQ,MAAM,0BAA2BA,CAAK,EACxCA,CACR,CACF,CAOA,MAAM,gBAA+C,CACnD,MAAMI,EAAU,MAAM,KAAK,gBAC3B,OAAO,KAAK,mBAAmBA,CAAO,CACxC,CAMA,mBAAmBA,EAAwC,CACzD,MAAMsC,MAAgB,IAGtB,UAAWvD,KAAaqD,EACtBE,EAAU,IAAIvD,EAAW,CAAC,EAI5B,OAAAiB,EAAQ,QAAQI,GAAU,CACxB,MAAMmC,EAAUD,EAAU,IAAIlC,EAAO,SAAS,GAAK,EACnDkC,EAAU,IAAIlC,EAAO,UAAWmC,EAAU,CAAC,CAC7C,CAAC,EAEMD,CACT,CAMA,MAAM,kBAAkBE,EAAe,EAA2B,CAChE,GAAI,CACF,MAAMC,MAAgB,KACtBA,EAAU,QAAQA,EAAU,UAAYD,CAAI,EAE5C,MAAMxD,EAAW,MAAM,MACrB,GAAGC,CAAY,4BAA4BC,EAAO,GAAG,uBAAuBuD,EAAU,aAAa,GACnG,CACE,OAAQ,MACR,QAAS,KAAK,WAAW,EAAI,EAC/B,EAGF,GAAI,CAACzD,EAAS,GACZ,MAAIA,EAAS,SAAW,IAChB,IAAI,MAAM,gDAAgD,EAE5D,IAAI,MAAM,yBAAyBA,EAAS,UAAU,EAAE,EAGhE,MAAMG,EAAO,MAAMH,EAAS,OAC5B,OAAO,MAAM,QAAQG,CAAI,EAAIA,EAAO,EACtC,OAASS,EAAO,CACd,cAAQ,MAAM,kCAAmCA,CAAK,EAChDA,CACR,CACF,CAMA,MAAM,qBAIH,CACD,GAAI,CACF,MAAM8C,EAAO,MAAM,KAAK,kBAAkB,CAAC,EACrCC,EAAU,MAAM,KAAK,kBAAkB,EAAE,EAEzCC,EAAQ,IAAI,OAAO,mBAAmB,OAAO,EAC7CC,EAA6B,GAC7BC,MAAa,IACbC,MAAqB,IAG3B,OAAAX,EAAe,QAAQrD,GAAa,CAClC+D,EAAO,IAAI/D,EAAW,CAAC,CACzB,CAAC,EAGD4D,EAAQ,QAAQK,GAAO,CACrB,MAAMzD,EAAQyD,EAAI,MAAM,MAAM,6BAA6B,EAC3D,GAAIzD,EAAO,CACT,MAAMR,EAAYQ,EAAM,CAAC,EACnBgD,EAAUO,EAAO,IAAI/D,CAAS,GAAK,EACzC+D,EAAO,IAAI/D,EAAWwD,EAAU,CAAC,EAGjC,MAAMU,EAAiB,IAAI,KAAKD,EAAI,UAAU,EAAE,mBAAmB,OAAO,EACpEE,EAAcH,EAAe,IAAIhE,CAAS,GAC5C,CAACmE,GAAe,IAAI,KAAKF,EAAI,UAAU,EAAI,IAAI,KAAKE,CAAW,IACjEH,EAAe,IAAIhE,EAAWkE,CAAc,CAEhD,CACF,CAAC,EAGDP,EAAK,QAAQM,GAAO,CAClB,MAAMzD,EAAQyD,EAAI,MAAM,MAAM,6BAA6B,EAC3D,GAAIzD,EAAO,CACT,MAAMR,EAAYQ,EAAM,CAAC,EACT,IAAI,KAAKyD,EAAI,UAAU,EAAE,mBAAmB,OAAO,IACnDJ,GAAS,CAACC,EAAiB,SAAS9D,CAAS,GAC3D8D,EAAiB,KAAK9D,CAAS,CAEnC,CACF,CAAC,EAEM,CAAE,MAAO8D,EAAkB,OAAAC,EAAQ,eAAAC,CAAA,CAC5C,OAASnD,EAAO,CACd,cAAQ,MAAM,mCAAoCA,CAAK,EACjDA,CACR,CACF,CAMA,MAAM,sBAKF,CACF,GAAI,CAEF,MAAM6C,MAAgB,KACtBA,EAAU,QAAQA,EAAU,UAAY,EAAE,EAE1C,MAAMzD,EAAW,MAAM,MACrB,GAAGC,CAAY,4BAA4BC,EAAO,MAAM,uBAAuBuD,EAAU,aAAa,GACtG,CACE,OAAQ,MACR,QAAS,KAAK,WAAW,EAAI,EAC/B,EAGF,GAAI,CAACzD,EAAS,GACZ,MAAM,IAAI,MAAM,yCAAyCA,EAAS,UAAU,EAAE,EAGhF,MAAMG,EAAO,MAAMH,EAAS,OAEtBI,EAAwB,MAAM,QAAQD,CAAI,EAAIA,EAAO,GACrDgE,MAAc,IAOpB,OAAA/D,EAAO,QAAQE,GAAS,CACtB,GAAIA,EAAM,MAAM,SAAS,SAAS,EAAG,CACnC,MAAMC,EAAQD,EAAM,MAAM,MAAME,CAAkB,EAClD,GAAID,EAAO,CACT,KAAM,EAAGR,EAAWU,EAAaC,CAAI,EAAIH,EACnCI,EAAM,GAAGF,CAAW,IAAIC,CAAI,GAElC,GAAIyD,EAAQ,IAAIxD,CAAG,EAAG,CACpB,MAAMR,EAAOgE,EAAQ,IAAIxD,CAAG,EAC5BR,EAAK,UAAU,IAAIJ,CAAS,EAC5BI,EAAK,aACP,MACEgE,EAAQ,IAAIxD,EAAK,CACf,YAAAF,EACA,UAAW,IAAI,IAAI,CAACV,CAAS,CAAC,EAC9B,YAAa,EACd,CAEL,CACF,CACF,CAAC,EAGqB,MAAM,KAAKoE,EAAQ,SAAS,EAC/C,OAAO,CAAC,EAAGhE,CAAI,IAAMA,EAAK,aAAe,CAAC,EAC1C,IAAI,CAAC,CAACQ,EAAKR,CAAI,KAAO,CACrB,KAAMQ,EAAI,MAAM,GAAG,EAAE,CAAC,EACtB,YAAaR,EAAK,YAClB,UAAW,MAAM,KAAKA,EAAK,SAAS,EACpC,YAAaA,EAAK,aAClB,EACD,KAAK,CAACiE,EAAGC,IAAMA,EAAE,YAAcD,EAAE,WAAW,CAGjD,OAASxD,EAAO,CACd,cAAQ,MAAM,mCAAoCA,CAAK,EACjDA,CACR,CACF,CAMA,MAAM,iBAAiBC,EAYuD,CAC5E,GAAI,CACF,MAAMb,EAAW,MAAM,MAAM,GAAGC,CAAY,UAAW,CACrD,OAAQ,OACR,QAAS,KAAK,aACd,KAAM,KAAK,UAAUY,CAAU,EAChC,EAED,GAAI,CAACb,EAAS,GACZ,MAAM,IAAI,MAAM,6BAA6B,EAG/C,OAAOA,EAAS,MAClB,OAASY,EAAO,CACd,cAAQ,MAAM,8BAA+BA,CAAK,EAC5CA,CACR,CACF,CAKA,MAAM,eAAe0D,EAA6C,CAChE,GAAI,CACF,MAAMtE,EAAW,MAAM,MAAM,GAAGC,CAAY,gBAAiB,CAC3D,OAAQ,MACR,QAAS,CACP,mBAAoBqE,CAAA,CACtB,CACD,EAED,GAAI,CAACtE,EAAS,GACZ,MAAIA,EAAS,SAAW,IAChB,IAAI,MAAM,cAAc,EAE1B,IAAI,MAAM,qCAAqC,EAGvD,OAAOA,EAAS,MAClB,OAASY,EAAO,CACd,cAAQ,MAAM,+BAAgCA,CAAK,EAC7CA,CACR,CACF,CAKA,MAAM,kBACJ0D,EACAC,EACoD,CACpD,GAAI,CACF,MAAMvE,EAAW,MAAM,MAAM,GAAGC,CAAY,gBAAiB,CAC3D,OAAQ,MACR,QAAS,CACP,eAAgB,mBAChB,mBAAoBqE,CAAA,EAEtB,KAAM,KAAK,UAAUC,CAAO,EAC7B,EAED,GAAI,CAACvE,EAAS,GACZ,MAAIA,EAAS,SAAW,IAChB,IAAI,MAAM,cAAc,EAE1B,IAAI,MAAM,sCAAsC,EAGxD,OAAOA,EAAS,MAClB,OAASY,EAAO,CACd,cAAQ,MAAM,+BAAgCA,CAAK,EAC7CA,CACR,CACF,CAKA,MAAM,iBAAiB0D,EAAuE,CAC5F,MAAMtE,EAAW,MAAM,MAAM,GAAGC,CAAY,eAAgB,CAC1D,OAAQ,OACR,QAAS,CACP,mBAAoBqE,CAAA,CACtB,CACD,EAED,GAAI,CAACtE,EAAS,GACZ,MAAIA,EAAS,SAAW,IAChB,IAAI,MAAM,cAAc,EAE1B,IAAI,MAAM,uBAAuB,EAGzC,OAAOA,EAAS,MAClB,CAKA,MAAM,cACJsE,EACAE,EAAsC,OACtCzE,EAOC,CACD,MAAM0E,EAAS,IAAI,gBAAgB,CACjC,UAAAD,EACA,GAAIzE,GAAa,CAAE,UAAAA,CAAA,CAAU,CAC9B,EAEKC,EAAW,MAAM,MAAM,GAAGC,CAAY,YAAYwE,CAAM,GAAI,CAChE,OAAQ,MACR,QAAS,CACP,mBAAoBH,CAAA,CACtB,CACD,EAED,GAAI,CAACtE,EAAS,GACZ,MAAIA,EAAS,SAAW,IAChB,IAAI,MAAM,cAAc,EAE5BA,EAAS,SAAW,IAChB,IAAI,MAAM,yBAAyB,EAErC,IAAI,MAAM,6BAA6B,EAG/C,OAAOA,EAAS,MAClB,CAKA,MAAc,4BACZgB,EACAjB,EACe,CACf,GAAI,CACF,MAAMC,EAAW,MAAM,MAAM,GAAGC,CAAY,gBAAiB,CAC3D,OAAQ,OACR,QAAS,KAAK,aACd,KAAM,KAAK,UAAU,CAAE,QAAAe,EAAS,UAAAjB,EAAW,EAC5C,EAED,GAAI,CAACC,EAAS,GACZ,MAAM,IAAI,MAAM,kCAAkCA,EAAS,UAAU,EAAE,EAGzE,MAAM0E,EAAS,MAAM1E,EAAS,OAC9B,QAAQ,IAAI,WAAW0E,EAAO,cAAgB,CAAC,sBAAsB1D,EAAQ,MAAM,UAAU,CAC/F,OAASJ,EAAO,CACd,cAAQ,MAAM,+BAAgCA,CAAK,EAC7CA,CACR,CACF,CACF,CAGO,MAAM+D,EAAgB,IAAIhF","names":["__iconNode","Calendar","createLucideIcon","Check","CircleCheckBig","TriangleAlert","Upload","X","Modal","isOpen","onClose","title","children","className","useEffect","jsxs","jsx","cn","GitHubService","password","isAdmin","headers","apparatus","response","API_BASE_URL","LABELS","data","issues","defectMap","issue","match","DEFECT_TITLE_REGEX","compartment","item","key","error","submission","user","date","defects","existingDefects","defectErrors","errorMessages","defect","defectKey","existingIssue","errorMsg","status","notes","reportedBy","rank","photoUrl","body","labels","issueNumber","verifiedBy","items","receiptURL","fallbackMarkdown","buildReceiptPayloadFromInspection","createHostedReceipt","buildReceiptMarkdown","__vitePreload","receiptPayload","receiptError","d","closeResponse","errorText","errorData","photoMatch","resolutionNote","resolvedBy","issueResponse","apparatusLabel","label","APPARATUS_LIST","newLabels","statusMap","current","days","sinceDate","logs","allLogs","today","todaySubmissions","totals","lastSubmission","log","submissionDate","currentLast","itemMap","a","b","adminPassword","updates","timeframe","params","result","githubService"],"ignoreList":[0,1,2,3,4,5],"sources":["../../node_modules/lucide-react/dist/esm/icons/calendar.js","../../node_modules/lucide-react/dist/esm/icons/check.js","../../node_modules/lucide-react/dist/esm/icons/circle-check-big.js","../../node_modules/lucide-react/dist/esm/icons/triangle-alert.js","../../node_modules/lucide-react/dist/esm/icons/upload.js","../../node_modules/lucide-react/dist/esm/icons/x.js","../../src/components/ui/Modal.tsx","../../src/lib/github.ts"],"sourcesContent":["/**\n * @license lucide-react v0.556.0 - ISC\n *\n * This source code is licensed under the ISC license.\n * See the LICENSE file in the root directory of this source tree.\n */\n\nimport createLucideIcon from '../createLucideIcon.js';\n\nconst __iconNode = [\n  [\"path\", { d: \"M8 2v4\", key: \"1cmpym\" }],\n  [\"path\", { d: \"M16 2v4\", key: \"4m81vk\" }],\n  [\"rect\", { width: \"18\", height: \"18\", x: \"3\", y: \"4\", rx: \"2\", key: \"1hopcy\" }],\n  [\"path\", { d: \"M3 10h18\", key: \"8toen8\" }]\n];\nconst Calendar = createLucideIcon(\"calendar\", __iconNode);\n\nexport { __iconNode, Calendar as default };\n//# sourceMappingURL=calendar.js.map\n","/**\n * @license lucide-react v0.556.0 - ISC\n *\n * This source code is licensed under the ISC license.\n * See the LICENSE file in the root directory of this source tree.\n */\n\nimport createLucideIcon from '../createLucideIcon.js';\n\nconst __iconNode = [[\"path\", { d: \"M20 6 9 17l-5-5\", key: \"1gmf2c\" }]];\nconst Check = createLucideIcon(\"check\", __iconNode);\n\nexport { __iconNode, Check as default };\n//# sourceMappingURL=check.js.map\n","/**\n * @license lucide-react v0.556.0 - ISC\n *\n * This source code is licensed under the ISC license.\n * See the LICENSE file in the root directory of this source tree.\n */\n\nimport createLucideIcon from '../createLucideIcon.js';\n\nconst __iconNode = [\n  [\"path\", { d: \"M21.801 10A10 10 0 1 1 17 3.335\", key: \"yps3ct\" }],\n  [\"path\", { d: \"m9 11 3 3L22 4\", key: \"1pflzl\" }]\n];\nconst CircleCheckBig = createLucideIcon(\"circle-check-big\", __iconNode);\n\nexport { __iconNode, CircleCheckBig as default };\n//# sourceMappingURL=circle-check-big.js.map\n","/**\n * @license lucide-react v0.556.0 - ISC\n *\n * This source code is licensed under the ISC license.\n * See the LICENSE file in the root directory of this source tree.\n */\n\nimport createLucideIcon from '../createLucideIcon.js';\n\nconst __iconNode = [\n  [\n    \"path\",\n    {\n      d: \"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3\",\n      key: \"wmoenq\"\n    }\n  ],\n  [\"path\", { d: \"M12 9v4\", key: \"juzpu7\" }],\n  [\"path\", { d: \"M12 17h.01\", key: \"p32p05\" }]\n];\nconst TriangleAlert = createLucideIcon(\"triangle-alert\", __iconNode);\n\nexport { __iconNode, TriangleAlert as default };\n//# sourceMappingURL=triangle-alert.js.map\n","/**\n * @license lucide-react v0.556.0 - ISC\n *\n * This source code is licensed under the ISC license.\n * See the LICENSE file in the root directory of this source tree.\n */\n\nimport createLucideIcon from '../createLucideIcon.js';\n\nconst __iconNode = [\n  [\"path\", { d: \"M12 3v12\", key: \"1x0j5s\" }],\n  [\"path\", { d: \"m17 8-5-5-5 5\", key: \"7q97r8\" }],\n  [\"path\", { d: \"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4\", key: \"ih7n3h\" }]\n];\nconst Upload = createLucideIcon(\"upload\", __iconNode);\n\nexport { __iconNode, Upload as default };\n//# sourceMappingURL=upload.js.map\n","/**\n * @license lucide-react v0.556.0 - ISC\n *\n * This source code is licensed under the ISC license.\n * See the LICENSE file in the root directory of this source tree.\n */\n\nimport createLucideIcon from '../createLucideIcon.js';\n\nconst __iconNode = [\n  [\"path\", { d: \"M18 6 6 18\", key: \"1bl5f8\" }],\n  [\"path\", { d: \"m6 6 12 12\", key: \"d8bk6v\" }]\n];\nconst X = createLucideIcon(\"x\", __iconNode);\n\nexport { __iconNode, X as default };\n//# sourceMappingURL=x.js.map\n","import React, { useEffect } from 'react';\r\nimport { X } from 'lucide-react';\r\nimport { cn } from '../../lib/utils';\r\n\r\ninterface ModalProps {\r\n  isOpen: boolean;\r\n  onClose: () => void;\r\n  title: string;\r\n  children: React.ReactNode;\r\n  className?: string;\r\n}\r\n\r\nexport const Modal: React.FC<ModalProps> = ({\r\n  isOpen,\r\n  onClose,\r\n  title,\r\n  children,\r\n  className,\r\n}) => {\r\n  useEffect(() => {\r\n    if (isOpen) {\r\n      document.body.style.overflow = 'hidden';\r\n    } else {\r\n      document.body.style.overflow = 'unset';\r\n    }\r\n\r\n    return () => {\r\n      document.body.style.overflow = 'unset';\r\n    };\r\n  }, [isOpen]);\r\n\r\n  if (!isOpen) return null;\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center\">\r\n      {/* Backdrop */}\r\n      <div\r\n        className=\"absolute inset-0 bg-black/50 backdrop-blur-sm\"\r\n        onClick={onClose}\r\n      />\r\n\r\n      {/* Modal */}\r\n      <div\r\n        className={cn(\r\n          'relative bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto',\r\n          className\r\n        )}\r\n      >\r\n        {/* Header */}\r\n        <div className=\"flex items-center justify-between px-6 py-4 border-b border-gray-200\">\r\n          <h2 className=\"text-xl font-semibold text-gray-900\">{title}</h2>\r\n          <button\r\n            onClick={onClose}\r\n            className=\"p-1 hover:bg-gray-100 rounded-lg transition-colors\"\r\n          >\r\n            <X className=\"w-5 h-5 text-gray-500\" />\r\n          </button>\r\n        </div>\r\n\r\n        {/* Content */}\r\n        <div className=\"px-6 py-4\">{children}</div>\r\n      </div>\r\n    </div>\r\n  );\r\n};","import type { Defect, GitHubIssue, InspectionSubmission, EmailConfig } from '../types';\r\nimport { APPARATUS_LIST, LABELS, DEFECT_TITLE_REGEX, API_BASE_URL } from './config';\r\n\r\nclass GitHubService {\r\n  private adminPassword: string | null = null;\r\n\r\n  constructor() {\r\n    // No token needed in frontend - handled by Cloudflare Worker\r\n  }\r\n\r\n  /**\r\n   * Set admin password for authenticated requests\r\n   */\r\n  setAdminPassword(password: string): void {\r\n    this.adminPassword = password;\r\n  }\r\n\r\n  /**\r\n   * Clear admin password\r\n   */\r\n  clearAdminPassword(): void {\r\n    this.adminPassword = null;\r\n  }\r\n\r\n  /**\r\n   * Check if admin is authenticated\r\n   */\r\n  isAdminAuthenticated(): boolean {\r\n    return this.adminPassword !== null;\r\n  }\r\n\r\n  /**\r\n   * Get headers for API requests\r\n   */\r\n  private getHeaders(isAdmin: boolean = false): HeadersInit {\r\n    const headers: HeadersInit = {\r\n      'Content-Type': 'application/json',\r\n    };\r\n\r\n    if (isAdmin && this.adminPassword) {\r\n      headers['X-Admin-Password'] = this.adminPassword;\r\n    }\r\n\r\n    return headers;\r\n  }\r\n\r\n  /**\r\n   * Fetch all open defects for a specific apparatus\r\n   * Returns a map of items to their issue numbers for quick lookup\r\n   */\r\n  async checkExistingDefects(apparatus: string): Promise<Map<string, GitHubIssue>> {\r\n    try {\r\n      const response = await fetch(\r\n        `${API_BASE_URL}/issues?state=open&labels=${LABELS.DEFECT},${encodeURIComponent(apparatus)}&per_page=100`,\r\n        {\r\n          method: 'GET',\r\n          headers: this.getHeaders(),\r\n        }\r\n      );\r\n\r\n      if (!response.ok) {\r\n        console.warn(`Failed to fetch defects: ${response.statusText}`);\r\n        // Return empty map instead of throwing - no existing defects is OK\r\n        return new Map<string, GitHubIssue>();\r\n      }\r\n\r\n      const data = await response.json();\r\n      \r\n      // Handle case where response is not an array (empty response, error, etc.)\r\n      const issues: GitHubIssue[] = Array.isArray(data) ? data : [];\r\n      const defectMap = new Map<string, GitHubIssue>();\r\n\r\n      for (const issue of issues) {\r\n        // Parse the issue title using the regex from config\r\n        const match = issue.title.match(DEFECT_TITLE_REGEX);\r\n        if (match) {\r\n          const [, , compartment, item] = match;\r\n          const key = `${compartment}:${item}`;\r\n          defectMap.set(key, issue);\r\n        }\r\n      }\r\n\r\n      return defectMap;\r\n    } catch (error) {\r\n      console.error('Error fetching existing defects:', error);\r\n      // Return empty map instead of throwing - allow inspection to continue\r\n      return new Map<string, GitHubIssue>();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Submit a checklist inspection\r\n   * Creates new issues for new defects, adds comments to existing ones\r\n   * Implements robust error handling: attempts all defects even if some fail\r\n   */\r\n  async submitChecklist(submission: InspectionSubmission): Promise<void> {\r\n    const { user, apparatus, date, defects } = submission;\r\n\r\n    // Get existing open defects for this apparatus\r\n    const existingDefects = await this.checkExistingDefects(apparatus);\r\n\r\n    // Track failures but continue processing all defects\r\n    let defectErrors = 0;\r\n    const errorMessages: string[] = [];\r\n\r\n    // Process each defect (attempt all even if some fail)\r\n    for (const defect of defects) {\r\n      try {\r\n        const defectKey = `${defect.compartment}:${defect.item}`;\r\n        const existingIssue = existingDefects.get(defectKey);\r\n\r\n        if (existingIssue) {\r\n          // Add comment to existing issue\r\n          await this.addCommentToDefect(\r\n            existingIssue.number,\r\n            user.name,\r\n            user.rank,\r\n            date,\r\n            defect.notes,\r\n            defect.photoUrl\r\n          );\r\n        } else {\r\n          // Create new issue\r\n          await this.createDefectIssue(\r\n            apparatus,\r\n            defect.compartment,\r\n            defect.item,\r\n            defect.status,\r\n            defect.notes,\r\n            user.name,\r\n            user.rank,\r\n            date,\r\n            defect.photoUrl\r\n          );\r\n        }\r\n      } catch (error) {\r\n        defectErrors++;\r\n        const errorMsg = `${defect.compartment}:${defect.item}`;\r\n        errorMessages.push(errorMsg);\r\n        console.error(`Failed to process defect ${errorMsg}:`, error);\r\n        // Continue to next defect instead of throwing\r\n      }\r\n    }\r\n\r\n    // If any defects failed, throw error before creating log\r\n    // This prevents incomplete submissions from being logged\r\n    if (defectErrors > 0) {\r\n      throw new Error(`Failed to submit ${defectErrors} defect(s): ${errorMessages.join(', ')}. Please try again.`);\r\n    }\r\n\r\n    // Create a log entry (closed issue) for the completed inspection\r\n    await this.createLogEntry(submission);\r\n\r\n    // After successful submission, trigger inventory cross-matching\r\n    if (defects.length > 0) {\r\n      try {\r\n        await this.createSupplyTasksForDefects(defects, apparatus);\r\n      } catch (error) {\r\n        console.error('Failed to create supply tasks (non-fatal):', error);\r\n        // Don't throw - defects were submitted successfully\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create a new defect issue\r\n   */\r\n  private async createDefectIssue(\r\n    apparatus: string,\r\n    compartment: string,\r\n    item: string,\r\n    status: 'missing' | 'damaged',\r\n    notes: string,\r\n    reportedBy: string,\r\n    rank: string,\r\n    date: string,\r\n    photoUrl?: string\r\n  ): Promise<void> {\r\n    const title = `[${apparatus}] ${compartment}: ${item} - ${status === 'missing' ? 'Missing' : 'Damaged'}`;\r\n    let body = `\r\n## Defect Report\r\n\r\n**Apparatus:** ${apparatus}\r\n**Compartment:** ${compartment}\r\n**Item:** ${item}\r\n**Status:** ${status === 'missing' ? '‚ùå Missing' : '‚ö†Ô∏è Damaged'}\r\n**Reported By:** ${reportedBy} (${rank})\r\n**Date:** ${date}\r\n\r\n### Notes\r\n${notes}\r\n`;\r\n\r\n    // Add photo if available\r\n    if (photoUrl) {\r\n      body += `\\n### Photo Evidence\\n\\n![Defect Photo](${photoUrl})\\n`;\r\n    }\r\n\r\n    body += `\\n---\r\n*This issue was automatically created by the MBFD Checkout System.*`;\r\n\r\n    body = body.trim();\r\n\r\n    const labels = [LABELS.DEFECT, apparatus];\r\n    if (status === 'damaged') {\r\n      labels.push(LABELS.DAMAGED);\r\n    }\r\n\r\n    try {\r\n      const response = await fetch(`${API_BASE_URL}/issues`, {\r\n        method: 'POST',\r\n        headers: this.getHeaders(),\r\n        body: JSON.stringify({ title, body, labels }),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`Failed to create issue: ${response.statusText}`);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error creating defect issue:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add a verification comment to an existing defect\r\n   */\r\n  private async addCommentToDefect(\r\n    issueNumber: number,\r\n    verifiedBy: string,\r\n    rank: string,\r\n    date: string,\r\n    notes?: string,\r\n    photoUrl?: string\r\n  ): Promise<void> {\r\n    let body = `\r\n### Verification Update\r\n\r\n**Verified still present by:** ${verifiedBy} (${rank})\r\n**Date:** ${date}\r\n\r\n${notes ? `**Additional Notes:** ${notes}` : ''}\r\n`;\r\n\r\n    // Add photo if available\r\n    if (photoUrl) {\r\n      body += `\\n### Photo Evidence\\n\\n![Defect Photo](${photoUrl})\\n`;\r\n    }\r\n\r\n    body += `\\n---\r\n*This comment was automatically added by the MBFD Checkout System.*`;\r\n\r\n    body = body.trim();\r\n\r\n    try {\r\n      const response = await fetch(`${API_BASE_URL}/issues/${issueNumber}/comments`, {\r\n        method: 'POST',\r\n        headers: this.getHeaders(),\r\n        body: JSON.stringify({ body }),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`Failed to add comment: ${response.statusText}`);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error adding comment to issue:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create a log entry for completed inspection\r\n   */\r\n  private async createLogEntry(submission: InspectionSubmission): Promise<void> {\r\n    const { user, apparatus, date, items } = submission;\r\n    \r\n    const title = `[${apparatus}] Daily Inspection - ${date}`;\r\n    \r\n    // Try to create a hosted receipt\r\n    let receiptURL: string | null = null;\r\n    let fallbackMarkdown = '';\r\n    \r\n    try {\r\n      // Import receipt helpers dynamically to avoid circular deps\r\n      const { buildReceiptPayloadFromInspection, createHostedReceipt, buildReceiptMarkdown } = await import('./receipt');\r\n      const receiptPayload = buildReceiptPayloadFromInspection(submission);\r\n      \r\n      // Attempt to create hosted receipt\r\n      try {\r\n        const response = await createHostedReceipt(API_BASE_URL, receiptPayload, this.adminPassword || undefined);\r\n        receiptURL = response.url;\r\n        console.log(`Created hosted receipt: ${receiptURL}`);\r\n      } catch (receiptError) {\r\n        console.error('Failed to create hosted receipt, using fallback:', receiptError);\r\n        // Build fallback markdown\r\n        fallbackMarkdown = buildReceiptMarkdown(receiptPayload);\r\n      }\r\n    } catch (error) {\r\n      console.error('Receipt module import failed:', error);\r\n      // Continue without receipt\r\n    }\r\n    \r\n    // Build issue body with receipt link or embedded markdown\r\n    let body = `\r\n## Daily Inspection Log\r\n\r\n**Apparatus:** ${apparatus}\r\n**Conducted By:** ${user.name} (${user.rank})\r\n**Date:** ${date}\r\n\r\n### Summary\r\n- **Total Items Checked:** ${items.length}\r\n- **Issues Found:** ${submission.defects.length}\r\n\r\n${submission.defects.length > 0 ? `\r\n### Issues Reported\r\n${submission.defects.map(d => `- ${d.compartment}: ${d.item} - ${d.status === 'missing' ? '‚ùå Missing' : '‚ö†Ô∏è Damaged'}`).join('\\n')}`\r\n : '‚úÖ All items present and working'}\r\n`;\r\n\r\n    // Add receipt link or fallback markdown\r\n    if (receiptURL) {\r\n      body += `\\n\\n---\\n\\nüìã **[View Full Printable Receipt](${receiptURL})**\\n\\n_This receipt contains the complete inspection details in a print-friendly format._\\n`;\r\n    } else if (fallbackMarkdown) {\r\n      body += `\\n\\n---\\n\\n${fallbackMarkdown}\\n`;\r\n    }\r\n    \r\n    body += `\\n---\r\n*This inspection log was automatically created by the MBFD Checkout System.*`;\r\n\r\n    body = body.trim();\r\n\r\n    try {\r\n      const response = await fetch(`${API_BASE_URL}/issues`, {\r\n        method: 'POST',\r\n        headers: this.getHeaders(),\r\n        body: JSON.stringify({\r\n          title,\r\n          body,\r\n          labels: [LABELS.LOG, apparatus],\r\n        }),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`Failed to create log: ${response.statusText}`);\r\n      }\r\n\r\n      const issue = await response.json();\r\n\r\n      // Immediately close the issue to mark it as a log entry\r\n      const closeResponse = await fetch(`${API_BASE_URL}/issues/${issue.number}`, {\r\n        method: 'PATCH',\r\n        headers: this.getHeaders(),\r\n        body: JSON.stringify({ state: 'closed' }),\r\n      });\r\n\r\n      if (!closeResponse.ok) {\r\n        // Log detailed error information for debugging\r\n        const errorText = await closeResponse.text();\r\n        let errorData;\r\n        try {\r\n          errorData = JSON.parse(errorText);\r\n        } catch (e) {\r\n          errorData = { message: errorText };\r\n        }\r\n        \r\n        console.error(`Failed to close log issue #${issue.number}:`, {\r\n          status: closeResponse.status,\r\n          statusText: closeResponse.statusText,\r\n          error: errorData,\r\n          message: errorData.message || 'Unknown error'\r\n        });\r\n        \r\n        // Don't throw - log was created successfully, just not closed\r\n        // The workaround of querying 'state=all' handles this\r\n        console.warn(`Log entry created as issue #${issue.number} but could not be closed. It may require manual closure or token permissions review.`);\r\n      } else {\r\n        console.log(`Successfully created and closed log issue #${issue.number}`);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error creating log entry:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Fetch all open defects across all apparatus (ADMIN ONLY)\r\n   */\r\n  async getAllDefects(): Promise<Defect[]> {\r\n    try {\r\n      const response = await fetch(\r\n        `${API_BASE_URL}/issues?state=open&labels=${LABELS.DEFECT}&per_page=100`,\r\n        {\r\n          method: 'GET',\r\n          headers: this.getHeaders(true), // Admin request\r\n        }\r\n      );\r\n\r\n      if (!response.ok) {\r\n        if (response.status === 401) {\r\n          throw new Error('Unauthorized. Please enter the admin password.');\r\n        }\r\n        throw new Error(`Failed to fetch defects: ${response.statusText}`);\r\n      }\r\n\r\n      const data = await response.json();\r\n      \r\n      // Handle case where response is not an array\r\n      const issues: GitHubIssue[] = Array.isArray(data) ? data : [];\r\n      return issues.map(issue => this.parseDefectFromIssue(issue));\r\n    } catch (error) {\r\n      console.error('Error fetching all defects:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Parse a defect object from a GitHub issue\r\n   */\r\n  private parseDefectFromIssue(issue: GitHubIssue): Defect {\r\n    const match = issue.title.match(DEFECT_TITLE_REGEX);\r\n    \r\n    let apparatus = 'Rescue 1';\r\n    let compartment = 'Unknown';\r\n    let item = 'Unknown';\r\n    let status: 'missing' | 'damaged' = 'missing';\r\n\r\n    if (match) {\r\n      apparatus = match[1];\r\n      compartment = match[2];\r\n      item = match[3];\r\n      const statusStr = match[4];\r\n      status = statusStr.toLowerCase() as 'missing' | 'damaged';\r\n    }\r\n\r\n    // Extract photo URL from issue body if present\r\n    let photoUrl: string | undefined;\r\n    if (issue.body) {\r\n      // Look for markdown image syntax: ![alt](url)\r\n      const photoMatch = issue.body.match(/!\\[.*?\\]\\((https?:\\/\\/[^\\)]+)\\)/);\r\n      if (photoMatch) {\r\n        photoUrl = photoMatch[1];\r\n      }\r\n    }\r\n\r\n    return {\r\n      issueNumber: issue.number,\r\n      apparatus,\r\n      compartment,\r\n      item,\r\n      status,\r\n      notes: issue.body || '',\r\n      reportedBy: issue.user?.login || 'Unknown',\r\n      reportedAt: issue.created_at,\r\n      updatedAt: issue.updated_at,\r\n      resolved: false,\r\n      photoUrl,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Resolve a defect by closing the issue (ADMIN ONLY)\r\n   */\r\n  async resolveDefect(issueNumber: number, resolutionNote: string, resolvedBy: string): Promise<void> {\r\n    try {\r\n      // First, fetch the issue to get its current labels\r\n      const issueResponse = await fetch(`${API_BASE_URL}/issues/${issueNumber}`, {\r\n        method: 'GET',\r\n        headers: this.getHeaders(true),\r\n      });\r\n\r\n      if (!issueResponse.ok) {\r\n        throw new Error(`Failed to fetch issue details: ${issueResponse.statusText}`);\r\n      }\r\n\r\n      const issue = await issueResponse.json();\r\n      const currentLabels = issue.labels.map((label: any) => label.name);\r\n      \r\n      // Preserve apparatus labels and defect label, add resolved label\r\n      const apparatusLabel = currentLabels.find((label: string) => \r\n        APPARATUS_LIST.includes(label as any)\r\n      );\r\n      const newLabels = [LABELS.DEFECT, LABELS.RESOLVED];\r\n      if (apparatusLabel) {\r\n        newLabels.push(apparatusLabel);\r\n      }\r\n      \r\n      // Add resolution comment\r\n      await fetch(`${API_BASE_URL}/issues/${issueNumber}/comments`, {\r\n        method: 'POST',\r\n        headers: this.getHeaders(true), // Admin request\r\n        body: JSON.stringify({\r\n          body: `\r\n## ‚úÖ Defect Resolved\r\n\r\n**Resolved By:** ${resolvedBy}\r\n**Date:** ${new Date().toISOString()}\r\n\r\n### Resolution\r\n${resolutionNote}\r\n\r\n---\r\n*This defect was marked as resolved via the MBFD Admin Dashboard.*\r\n`.trim(),\r\n        }),\r\n      });\r\n\r\n      // Close the issue and update labels (preserving apparatus label)\r\n      const response = await fetch(`${API_BASE_URL}/issues/${issueNumber}`, {\r\n        method: 'PATCH',\r\n        headers: this.getHeaders(true), // Admin request\r\n        body: JSON.stringify({\r\n          state: 'closed',\r\n          labels: newLabels,\r\n        }),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        if (response.status === 401) {\r\n          throw new Error('Unauthorized. Please enter the admin password.');\r\n        }\r\n        throw new Error(`Failed to resolve defect: ${response.statusText}`);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error resolving defect:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get fleet status summary - computes from defect list (ADMIN ONLY)\r\n   * This method is kept for backward compatibility but should be deprecated\r\n   * in favor of computing status directly from getAllDefects() result\r\n   */\r\n  async getFleetStatus(): Promise<Map<string, number>> {\r\n    const defects = await this.getAllDefects();\r\n    return this.computeFleetStatus(defects);\r\n  }\r\n\r\n  /**\r\n   * Compute fleet status from a list of defects\r\n   * Useful for avoiding redundant API calls\r\n   */\r\n  computeFleetStatus(defects: Defect[]): Map<string, number> {\r\n    const statusMap = new Map<string, number>();\r\n\r\n    // Initialize all apparatus with 0 defects\r\n    for (const apparatus of APPARATUS_LIST) {\r\n      statusMap.set(apparatus, 0);\r\n    }\r\n\r\n    // Count defects per apparatus\r\n    defects.forEach(defect => {\r\n      const current = statusMap.get(defect.apparatus) || 0;\r\n      statusMap.set(defect.apparatus, current + 1);\r\n    });\r\n\r\n    return statusMap;\r\n  }\r\n\r\n  /**\r\n   * Fetch inspection logs (ADMIN ONLY)\r\n   * Get issues with 'Log' label (querying all states since closing may fail)\r\n   */\r\n  async getInspectionLogs(days: number = 7): Promise<GitHubIssue[]> {\r\n    try {\r\n      const sinceDate = new Date();\r\n      sinceDate.setDate(sinceDate.getDate() - days);\r\n      \r\n      const response = await fetch(\r\n        `${API_BASE_URL}/issues?state=all&labels=${LABELS.LOG}&per_page=100&since=${sinceDate.toISOString()}`,\r\n        {\r\n          method: 'GET',\r\n          headers: this.getHeaders(true), // Admin request\r\n        }\r\n      );\r\n\r\n      if (!response.ok) {\r\n        if (response.status === 401) {\r\n          throw new Error('Unauthorized. Please enter the admin password.');\r\n        }\r\n        throw new Error(`Failed to fetch logs: ${response.statusText}`);\r\n      }\r\n\r\n      const data = await response.json();\r\n      return Array.isArray(data) ? data : [];\r\n    } catch (error) {\r\n      console.error('Error fetching inspection logs:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get daily submission statistics (ADMIN ONLY)\r\n   * Returns which vehicles have submitted today and total submissions per vehicle\r\n   */\r\n  async getDailySubmissions(): Promise<{\r\n    today: string[];\r\n    totals: Map<string, number>;\r\n    lastSubmission: Map<string, string>;\r\n  }> {\r\n    try {\r\n      const logs = await this.getInspectionLogs(1); // Today's logs\r\n      const allLogs = await this.getInspectionLogs(30); // Last 30 days for totals\r\n      \r\n      const today = new Date().toLocaleDateString('en-US');\r\n      const todaySubmissions: string[] = [];\r\n      const totals = new Map<string, number>();\r\n      const lastSubmission = new Map<string, string>();\r\n      \r\n      // Initialize totals for all apparatus\r\n      APPARATUS_LIST.forEach(apparatus => {\r\n        totals.set(apparatus, 0);\r\n      });\r\n      \r\n      // Process all logs for totals and find latest submissions\r\n      allLogs.forEach(log => {\r\n        const match = log.title.match(/\\[(.+)\\]\\s+Daily Inspection/);\r\n        if (match) {\r\n          const apparatus = match[1];\r\n          const current = totals.get(apparatus) || 0;\r\n          totals.set(apparatus, current + 1);\r\n          \r\n          // Track most recent submission date\r\n          const submissionDate = new Date(log.created_at).toLocaleDateString('en-US');\r\n          const currentLast = lastSubmission.get(apparatus);\r\n          if (!currentLast || new Date(log.created_at) > new Date(currentLast)) {\r\n            lastSubmission.set(apparatus, submissionDate);\r\n          }\r\n        }\r\n      });\r\n      \r\n      // Check today's submissions\r\n      logs.forEach(log => {\r\n        const match = log.title.match(/\\[(.+)\\]\\s+Daily Inspection/);\r\n        if (match) {\r\n          const apparatus = match[1];\r\n          const logDate = new Date(log.created_at).toLocaleDateString('en-US');\r\n          if (logDate === today && !todaySubmissions.includes(apparatus)) {\r\n            todaySubmissions.push(apparatus);\r\n          }\r\n        }\r\n      });\r\n      \r\n      return { today: todaySubmissions, totals, lastSubmission };\r\n    } catch (error) {\r\n      console.error('Error getting daily submissions:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Analyze defects to identify low stock items (ADMIN ONLY)\r\n   * Items reported as missing multiple times may indicate supply issues\r\n   */\r\n  async analyzeLowStockItems(): Promise<Array<{\r\n    item: string;\r\n    compartment: string;\r\n    apparatus: string[];\r\n    occurrences: number;\r\n  }>> {\r\n    try {\r\n      // Get all defects from last 30 days\r\n      const sinceDate = new Date();\r\n      sinceDate.setDate(sinceDate.getDate() - 30);\r\n      \r\n      const response = await fetch(\r\n        `${API_BASE_URL}/issues?state=all&labels=${LABELS.DEFECT}&per_page=100&since=${sinceDate.toISOString()}`,\r\n        {\r\n          method: 'GET',\r\n          headers: this.getHeaders(true),\r\n        }\r\n      );\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`Failed to fetch defects for analysis: ${response.statusText}`);\r\n      }\r\n\r\n      const data = await response.json();\r\n      // Handle case where response is not an array\r\n      const issues: GitHubIssue[] = Array.isArray(data) ? data : [];\r\n      const itemMap = new Map<string, {\r\n        compartment: string;\r\n        apparatus: Set<string>;\r\n        occurrences: number;\r\n      }>();\r\n\r\n      // Analyze missing items\r\n      issues.forEach(issue => {\r\n        if (issue.title.includes('Missing')) {\r\n          const match = issue.title.match(DEFECT_TITLE_REGEX);\r\n          if (match) {\r\n            const [, apparatus, compartment, item] = match;\r\n            const key = `${compartment}:${item}`;\r\n            \r\n            if (itemMap.has(key)) {\r\n              const data = itemMap.get(key)!;\r\n              data.apparatus.add(apparatus);\r\n              data.occurrences++;\r\n            } else {\r\n              itemMap.set(key, {\r\n                compartment,\r\n                apparatus: new Set([apparatus]),\r\n                occurrences: 1,\r\n              });\r\n            }\r\n          }\r\n        }\r\n      });\r\n\r\n      // Convert to array and filter items with multiple occurrences\r\n      const lowStockItems = Array.from(itemMap.entries())\r\n        .filter(([, data]) => data.occurrences >= 2) // 2+ occurrences suggests supply issue\r\n        .map(([key, data]) => ({\r\n          item: key.split(':')[1],\r\n          compartment: data.compartment,\r\n          apparatus: Array.from(data.apparatus),\r\n          occurrences: data.occurrences,\r\n        }))\r\n        .sort((a, b) => b.occurrences - a.occurrences);\r\n\r\n      return lowStockItems;\r\n    } catch (error) {\r\n      console.error('Error analyzing low stock items:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Send notification after inspection submission\r\n   * Queues notification for daily digest or sends immediately based on configuration\r\n   */\r\n  async sendNotification(submission: {\r\n    apparatus: string;\r\n    operator: string;\r\n    checklistType: string;\r\n    totalItems: number;\r\n    completedItems: number;\r\n    defects: Array<{\r\n      item: string;\r\n      category: string;\r\n      severity: 'critical' | 'high' | 'medium' | 'low';\r\n    }>;\r\n    githubIssueUrl?: string;\r\n  }): Promise<{ success: boolean; notification_sent: string; message: string }> {\r\n    try {\r\n      const response = await fetch(`${API_BASE_URL}/notify`, {\r\n        method: 'POST',\r\n        headers: this.getHeaders(),\r\n        body: JSON.stringify(submission),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error('Failed to send notification');\r\n      }\r\n\r\n      return response.json();\r\n    } catch (error) {\r\n      console.error('Error sending notification:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get email configuration (ADMIN ONLY)\r\n   */\r\n  async getEmailConfig(adminPassword: string): Promise<EmailConfig> {\r\n    try {\r\n      const response = await fetch(`${API_BASE_URL}/config/email`, {\r\n        method: 'GET',\r\n        headers: {\r\n          'X-Admin-Password': adminPassword,\r\n        },\r\n      });\r\n\r\n      if (!response.ok) {\r\n        if (response.status === 401) {\r\n          throw new Error('Unauthorized');\r\n        }\r\n        throw new Error('Failed to fetch email configuration');\r\n      }\r\n\r\n      return response.json();\r\n    } catch (error) {\r\n      console.error('Error fetching email config:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update email configuration (ADMIN ONLY)\r\n   */\r\n  async updateEmailConfig(\r\n    adminPassword: string,\r\n    updates: Partial<EmailConfig>\r\n  ): Promise<{ success: boolean; config: EmailConfig }> {\r\n    try {\r\n      const response = await fetch(`${API_BASE_URL}/config/email`, {\r\n        method: 'PUT',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'X-Admin-Password': adminPassword,\r\n        },\r\n        body: JSON.stringify(updates),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        if (response.status === 401) {\r\n          throw new Error('Unauthorized');\r\n        }\r\n        throw new Error('Failed to update email configuration');\r\n      }\r\n\r\n      return response.json();\r\n    } catch (error) {\r\n      console.error('Error updating email config:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Manually trigger daily digest (ADMIN ONLY)\r\n   */\r\n  async sendManualDigest(adminPassword: string): Promise<{ success: boolean; message: string }> {\r\n    const response = await fetch(`${API_BASE_URL}/digest/send`, {\r\n      method: 'POST',\r\n      headers: {\r\n        'X-Admin-Password': adminPassword,\r\n      },\r\n    });\r\n\r\n    if (!response.ok) {\r\n      if (response.status === 401) {\r\n        throw new Error('Unauthorized');\r\n      }\r\n      throw new Error('Failed to send digest');\r\n    }\r\n\r\n    return response.json();\r\n  }\r\n\r\n  /**\r\n   * Get AI-generated fleet insights (admin only, requires Workers AI)\r\n   */\r\n  async getAIInsights(\r\n    adminPassword: string,\r\n    timeframe: 'week' | 'month' | 'all' = 'week',\r\n    apparatus?: string\r\n  ): Promise<{\r\n    insights: string[];\r\n    dataPoints: number;\r\n    timeframe: string;\r\n    apparatus: string;\r\n    generatedAt: string;\r\n  }> {\r\n    const params = new URLSearchParams({\r\n      timeframe,\r\n      ...(apparatus && { apparatus })\r\n    });\r\n\r\n    const response = await fetch(`${API_BASE_URL}/analyze?${params}`, {\r\n      method: 'GET',\r\n      headers: {\r\n        'X-Admin-Password': adminPassword,\r\n      },\r\n    });\r\n\r\n    if (!response.ok) {\r\n      if (response.status === 401) {\r\n        throw new Error('Unauthorized');\r\n      }\r\n      if (response.status === 503) {\r\n        throw new Error('AI features not enabled');\r\n      }\r\n      throw new Error('Failed to fetch AI insights');\r\n    }\r\n\r\n    return response.json();\r\n  }\r\n\r\n  /**\r\n   * Create supply tasks for reported defects by cross-matching with inventory\r\n   */\r\n  private async createSupplyTasksForDefects(\r\n    defects: Array<{ compartment: string; item: string; status: 'missing' | 'damaged' }>,\r\n    apparatus: string\r\n  ): Promise<void> {\r\n    try {\r\n      const response = await fetch(`${API_BASE_URL}/tasks/create`, {\r\n        method: 'POST',\r\n        headers: this.getHeaders(),\r\n        body: JSON.stringify({ defects, apparatus }),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`Failed to create supply tasks: ${response.statusText}`);\r\n      }\r\n\r\n      const result = await response.json();\r\n      console.log(`Created ${result.tasksCreated || 0} supply tasks from ${defects.length} defects`);\r\n    } catch (error) {\r\n      console.error('Error creating supply tasks:', error);\r\n      throw error;\r\n    }\r\n  }\r\n}\r\n\r\n// Export a singleton instance\r\nexport const githubService = new GitHubService();"],"file":"github-DwNqGJYJ.js"}