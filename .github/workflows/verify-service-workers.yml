name: Verify Service Workers

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  verify-service-workers:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Root Service Worker
        run: |
          echo "Verifying /sw.js..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://support.darleyplex.com/sw.js)
          if [ "$HTTP_CODE" != "200" ]; then
            echo "ERROR: /sw.js returned $HTTP_CODE, expected 200"
            exit 1
          fi
          echo "✓ /sw.js returned 200"
          
          # Verify content type is JavaScript
          CONTENT_TYPE=$(curl -s -I https://support.darleyplex.com/sw.js | grep -i content-type | cut -d' ' -f2 | tr -d '\r')
          echo "Content-Type: $CONTENT_TYPE"
          if [[ "$CONTENT_TYPE" != *"javascript"* && "$CONTENT_TYPE" != *"text/plain"* ]]; then
            echo "WARNING: Unexpected Content-Type for service worker"
          fi
          
          # Verify push event handler exists (only if file exists in repo)
          if [ -f "public/sw.js" ]; then
            if grep -q "addEventListener('push'" public/sw.js; then
              echo "✓ /sw.js has push event handler"
            else
              echo "WARNING: /sw.js is missing push event handler"
            fi
          else
            echo "ℹ Skipping file check - public/sw.js not in repo"
          fi

      - name: Verify Daily PWA Service Worker
        run: |
          echo "Verifying /daily/service-worker.js..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://support.darleyplex.com/daily/service-worker.js)
          if [ "$HTTP_CODE" != "200" ]; then
            echo "ERROR: /daily/service-worker.js returned $HTTP_CODE, expected 200"
            exit 1
          fi
          echo "✓ /daily/service-worker.js returned 200"
          
          # Verify push event handler exists (only if file exists in repo)
          if [ -f "resources/js/daily-checkout/public/service-worker.js" ]; then
            if grep -q "addEventListener('push'" resources/js/daily-checkout/public/service-worker.js; then
              echo "✓ /daily/service-worker.js has push event handler"
            else
              echo "WARNING: /daily/service-worker.js is missing push event handler"
            fi
          else
            echo "ℹ Skipping file check - service-worker.js not in repo"
          fi

      - name: Verify Daily Manifest
        run: |
          echo "Verifying /daily/manifest.json..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://support.darleyplex.com/daily/manifest.json)
          if [ "$HTTP_CODE" != "200" ]; then
            echo "ERROR: /daily/manifest.json returned $HTTP_CODE, expected 200"
            exit 1
          fi
          echo "✓ /daily/manifest.json returned 200"
          
          # Verify JSON is valid
          if curl -s https://support.darleyplex.com/daily/manifest.json | python3 -m json.tool > /dev/null 2>&1; then
            echo "✓ /daily/manifest.json is valid JSON"
          else
            echo "ERROR: /daily/manifest.json is not valid JSON"
            exit 1
          fi

      - name: Verify Root Manifest
        run: |
          echo "Verifying /manifest.json..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://support.darleyplex.com/manifest.json)
          if [ "$HTTP_CODE" != "200" ]; then
            echo "ERROR: /manifest.json returned $HTTP_CODE, expected 200"
            exit 1
          fi
          echo "✓ /manifest.json returned 200"
          
          # Verify JSON is valid
          if curl -s https://support.darleyplex.com/manifest.json | python3 -m json.tool > /dev/null 2>&1; then
            echo "✓ /manifest.json is valid JSON"
          else
            echo "ERROR: /manifest.json is not valid JSON"
            exit 1
          fi

      - name: Verify Push API Endpoint
        run: |
          echo "Verifying /api/push/vapid-public-key..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://support.darleyplex.com/api/push/vapid-public-key)
          if [ "$HTTP_CODE" != "401" ] && [ "$HTTP_CODE" != "200" ]; then
            echo "WARNING: /api/push/vapid-public-key returned $HTTP_CODE, expected 401 or 200"
          else
            echo "✓ /api/push/vapid-public-key returned $HTTP_CODE (expected auth requirement)"
          fi
