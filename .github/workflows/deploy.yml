name: Deploy to VPS

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: production-deployment
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://support.darleyplex.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $VPS_HOST >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST 'bash -s' << 'EOF'
            set -e
            cd /root/mbfd-hub
            
            # Create backup before deploy
            BACKUP_FILE="backups/mbfd_hub_$(date +%Y%m%d_%H%M%S).sql"
            mkdir -p backups
            docker compose exec -T pgsql pg_dump -U mbfd_user mbfd_hub > "$BACKUP_FILE"
            echo "✓ Backup created: $BACKUP_FILE"
            
            # Pull latest changes and reset to origin (deterministic deploy)
            git fetch origin
            git reset --hard origin/main
            git clean -fd
            echo "✓ Repository reset to origin/main"
            
            # Rebuild and restart containers
            docker compose up -d --build
            echo "✓ Containers rebuilt and restarted"
            
            # Wait for containers to be healthy
            sleep 10
            
            # Run Laravel commands
            docker compose exec -T laravel.test php artisan migrate --force
            docker compose exec -T laravel.test php artisan optimize:clear
            docker compose exec -T laravel.test php artisan config:cache
            docker compose exec -T laravel.test php artisan route:cache
            docker compose exec -T laravel.test php artisan view:cache
            docker compose exec -T laravel.test php artisan filament:clear-cached-components
            echo "✓ Laravel optimizations complete"
            
            # Build daily-checkout frontend
            cd resources/js/daily-checkout
            npm ci
            npm run build
            cd /root/mbfd-hub
            echo "✓ Daily-checkout frontend built"
          EOF

      - name: Deploy Cloudflare Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          workingDirectory: 'cloudflare-worker'
          command: deploy

      - name: Purge Cloudflare Cache
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          curl -X POST "https://api.cloudflare.com/client/v4/zones/$CLOUDFLARE_ZONE_ID/purge_cache" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" \
            --data '{"files":["https://support.darleyplex.com/daily/index.html","https://support.darleyplex.com/daily/","https://support.darleyplex.com/__version","https://www.mbfdhub.com/daily/index.html","https://www.mbfdhub.com/daily/","https://www.mbfdhub.com/__version"]}'
          echo "✓ Cloudflare cache purged"

      - name: Run Smoke Tests
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          echo "Running smoke tests..."
          sleep 5
          
          # Test version endpoint
          if curl -sf https://support.darleyplex.com/__version | jq .; then
            echo "✓ Version endpoint check passed"
          else
            echo "⚠ Version endpoint check failed"
          fi
          
          # Test daily checkout page
          if curl -sf https://support.darleyplex.com/daily/ -o /dev/null; then
            echo "✓ Daily checkout accessible"
          else
            echo "⚠ Daily checkout check failed"
          fi

      - name: Verify Service Workers
        run: |
          echo "Verifying /sw.js..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://support.darleyplex.com/sw.js)
          if [ "$HTTP_CODE" != "200" ]; then
            echo "ERROR: /sw.js returned $HTTP_CODE, expected 200"
            exit 1
          fi
          echo "✓ /sw.js returned 200"
          
          # Verify content type is JavaScript
          CONTENT_TYPE=$(curl -s -I https://support.darleyplex.com/sw.js | grep -i content-type | cut -d' ' -f2 | tr -d '\r')
          echo "Content-Type: $CONTENT_TYPE"
          if [[ "$CONTENT_TYPE" != *"javascript"* && "$CONTENT_TYPE" != *"text/plain"* ]]; then
            echo "WARNING: Unexpected Content-Type for service worker"
          fi

          echo "Verifying /daily/service-worker.js..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://support.darleyplex.com/daily/service-worker.js)
          if [ "$HTTP_CODE" != "200" ]; then
            echo "ERROR: /daily/service-worker.js returned $HTTP_CODE, expected 200"
            exit 1
          fi
          echo "✓ /daily/service-worker.js returned 200"

          echo "Verifying /manifest.json..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://support.darleyplex.com/manifest.json)
          if [ "$HTTP_CODE" != "200" ]; then
            echo "ERROR: /manifest.json returned $HTTP_CODE, expected 200"
            exit 1
          fi
          echo "✓ /manifest.json returned 200"
          
          echo "✓ Deployment and Verification complete!"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "❌ Deployment failed! Check the logs above for details."
          exit 1
