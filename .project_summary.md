# MBFD Support Hub - Comprehensive Project Summary

**Generated**: 2026-02-09  
**Last Updated**: 2026-02-17  
**Status**: Production Ready ✅  
**Environment**: VPS 145.223.73.170 (Hostinger Docker VPS)  
**Domain**: https://support.darleyplex.com

⚠️ **IMPORTANT**: This file contains PROJECT STRUCTURE and SECRET LOCATIONS ONLY (no actual credentials). Git-ignored for safety.

---

## 1. Overall Architecture Summary

### Technology Stack

**Backend**:
- **Framework**: Laravel 11.31
- **Admin Panel**: Filament v3.2
- **Real-time UI**: Livewire v3
- **PHP**: 8.5.2 (in container; composer.json requires ^8.2)
- **Database**: PostgreSQL 18-alpine
- **Queue**: Database-backed
- **Cache**: Database-backed
- **Error Tracking**: Sentry
- **PDF Generation**: barryvdh/laravel-dompdf

**Frontend**:
- **Admin Panel**: Filament (Blade + Livewire + Alpine.js)
- **Daily Checkout SPA**: React 18 + TypeScript + Vite
- **Forms Hub**: React 18 + TypeScript
- **Styling**: Tailwind CSS
- **PWA**: Service Worker + Web App Manifest

**Infrastructure**:
- **Containerization**: Docker Compose
- **Web Server**: Laravel Sail (PHP-FPM + nginx)
- **Reverse Proxy**: Cloudflare CDN (proxies support.darleyplex.com)
- **CI/CD**: GitHub Actions
- **Version Control**: GitHub (public repository)

### Docker Topology

```yaml
services:
  laravel.test:
    image: sail-8.5/app
    ports:
      - 80:80 (HTTP)
      - 127.0.0.1:5173:5173 (Vite HMR)
    depends_on: pgsql
    volumes:
      - .:/var/www/html

  pgsql:
    image: postgres:18-alpine
    ports:
      - 127.0.0.1:5432:5432 (BOUND TO LOCALHOST ONLY - Security Hardened)
    volumes:
      - sail-pgsql:/var/lib/postgresql

  baserow:
    image: baserow/baserow:latest
    ports:
      - 127.0.0.1:8082:80 (BOUND TO LOCALHOST ONLY)
    volumes:
      - baserow_data:/baserow/data
```

**Network**: Bridge network `sail`  
**Volumes**: `sail-pgsql` (persistent PostgreSQL data), `baserow_data` (Baserow data)

### Cloudflare Integration

- **DNS**: A record for support.darleyplex.com → 145.223.73.170
- **CDN**: Proxied through Cloudflare (orange cloud)
- **SSL**: Cloudflare Flexible SSL
- **Worker**: `mbfd-support-ai.pdarleyjr.workers.dev` (AI features)
- **Cache Purging**: Automated via deployment script

---

## 2. Executive Technical Status

### Application State: ✅ PRODUCTION READY

All critical features are deployed and operational:

#### ✅ Core Features (Completed)
- Fire apparatus tracking and inspection system
- Capital projects management (budget, milestones, AI tracking)
- Under-25k projects tracking
- Shop work orders and maintenance tracking
- **Station Inventory V2** (`/station-inventory-v2`) - PIN-gated on-hand counts with low-stock alerts
- Station Inventory V1 (preserved for audit/PDF) - Original submission-based system
- Single gas meters tracking with expiration alerts
- Uniform inventory management
- Todo/task management system with Kanban board
- **Daily Checkout React SPA** (`/daily`) - Offline-capable PWA
- **Forms Hub** (`/forms-hub`) - Centralized form submission portal with Big Ticket Item Request
- Equipment allocation and inventory management
- **Training Division Panel** (`/training`) - Separate Filament panel for Training Division
- **Real-time Chat** (`/admin/chatify`, `/training/chatify`) - Chatify + Laravel Reverb WebSocket messaging

#### ✅ Feature Flags (Current State)
- `FEATURE_REPLENISHMENT_DASHBOARD=false` — Replenishment dashboard disabled in production
- `FEATURE_EMAIL_SENDING=false` — Gmail OAuth implemented but disabled in production

#### ✅ Integrations (Operational)
- **Sentry**: Error tracking for both backend (Laravel) and frontend (React)
- **Cloudflare Workers AI**: AI-driven project insights
- **GitHub Actions**: Automated CI/CD pipeline (fixed 2026-02-17)
- **Web Push Notifications**: Browser push via Service Worker
- **VAPID Keys**: Web push authentication configured

---

## 3. CI/CD Workflows (Current State as of 2026-02-17)

| Workflow | File | Status | Notes |
|----------|------|--------|-------|
| CI | `ci.yml` | ✅ FIXED | PHP 8.3, PostgreSQL 15 service, proper DB config |
| Deploy to VPS | `deploy.yml` | ✅ Active | SSH deploy + Cloudflare Worker + smoke tests |
| Lighthouse CI | `lighthouse.yml` | ✅ Active | Audits production URL |
| Observability | `observability.yml` | ✅ Active | Sentry release creation |

**Removed workflows** (2026-02-17):
- `deploy-vps.yml` — Self-hosted runner (no runner configured)
- `deploy-vps.yml.disabled` — Disabled version
- `runner-smoke-test.yml` — Self-hosted runner smoke test

**CI Fix Details**:
- Root cause: PHP 8.2 specified but app runs 8.5.2; no PostgreSQL service; no DB env vars
- Fix: PHP 8.3, PostgreSQL 15 service container, explicit DB env vars, `pdo_pgsql` extension

---

## 4. Secrets Inventory (BY NAME AND LOCATION ONLY)

⚠️ **NO ACTUAL VALUES ARE STORED IN THIS DOCUMENT**

### Application Secrets
- `APP_KEY` — `.env` — Laravel encryption key
- `DB_USERNAME`, `DB_PASSWORD` — `.env` — Database credentials
- `REVERB_APP_KEY`, `REVERB_APP_SECRET`, `REVERB_APP_ID` — `.env` — WebSocket auth

### API Keys & Tokens
- `CLOUDFLARE_API_TOKEN`, `CLOUDFLARE_ACCOUNT_ID`, `CLOUDFLARE_ZONE_ID` — `.env`
- `SENTRY_LARAVEL_DSN`, `VITE_SENTRY_DSN`, `SENTRY_AUTH_TOKEN` — `.env`
- `VAPID_PUBLIC_KEY`, `VAPID_PRIVATE_KEY`, `VAPID_SUBJECT` — `.env`

### GitHub Actions Secrets Required
- `VPS_SSH_KEY`, `VPS_HOST`, `VPS_USER` — VPS deployment
- `CLOUDFLARE_API_TOKEN`, `CLOUDFLARE_ZONE_ID` — Cloudflare operations
- `SENTRY_AUTH_TOKEN`, `SENTRY_ORG`, `SENTRY_PROJECT_BACKEND`, `SENTRY_PROJECT_FRONTEND`, `VITE_SENTRY_DSN` — Observability

---

## 5. How to Deploy

### Automated Deployment (Recommended)

```bash
# SSH into VPS
ssh -i ~/.ssh/id_ed25519_hpb_docker root@145.223.73.170
cd /root/mbfd-hub
./scripts/deploy.sh
```

### Manual Deployment

```bash
cd /root/mbfd-hub
git fetch origin && git reset --hard origin/main && git clean -fd
docker compose up -d --build
docker compose exec -T laravel.test php artisan migrate --force
docker compose exec -T laravel.test php artisan optimize:clear
docker compose exec -T laravel.test php artisan config:cache
docker compose exec -T laravel.test php artisan route:cache
docker compose exec -T laravel.test php artisan view:cache
docker compose exec -T laravel.test php artisan filament:clear-cached-components
cd resources/js/daily-checkout && npm ci && npm run build
```

---

## 6. Production Smoke Tests (2026-02-17)

| Endpoint | Status |
|----------|--------|
| `https://support.darleyplex.com/admin/login` | ✅ 200 |
| `https://support.darleyplex.com/daily` | ✅ 200 |
| `https://support.darleyplex.com/admin/replenishment-dashboards` | ✅ 302 (auth redirect) |

---

## 7. Branch Status (2026-02-17)

- **Active**: `main` only
- **Stale (recommend delete)**: All 19 other branches
- `feature/grainger-links-and-replenishment` has same SHA as main (already merged)
- `session/agent_689e2cf8-c19f-40e5-8ff1-27794dce8307` — AI agent session branch, delete

---

## 8. Recent Incidents & Fixes

### 2026-02-17 — Health Check & Maintenance
- CI workflow fixed (PHP 8.3, PostgreSQL service)
- 3 obsolete workflows removed
- 25+ garbage files removed from workspace
- 43 old SQL backups removed (Jan 2026)

### 2026-02-15 — Chatify/StationResource Fixes
- StationResource syntax error fixed (missing `];`)
- Favicon replaced with MBFD favicon.ico

### 2026-02-14 — Inventory & Chatify Fixes
- Inventory URL concatenation bug fixed
- Chatify jQuery load order fixed
- Service worker MIME type verified

### 2026-02-11 to 2026-02-13 — Chatify/Reverb Rescue
- Full Chatify rescue: duplicate Alpine/Livewire, chatify.js 404, broadcasting misconfiguration
- Station Inventory V2 implemented (PIN-gated, PAR alerts, audit trail)

### 2026-02-10 — Dashboard Fixes
- `stations.name` column error fixed (use `station_number`)
- ChFavorite model deployed to production

### 2026-02-09 — Training Panel & Baserow
- Training panel notifications moved to Settings page
- 9 Baserow users provisioned

---

## 9. Common Maintenance Tasks

```bash
# Clear all caches
docker compose exec laravel.test php artisan optimize:clear

# Regenerate caches
docker compose exec laravel.test php artisan config:cache
docker compose exec laravel.test php artisan route:cache
docker compose exec laravel.test php artisan view:cache

# Check system health
docker compose ps
docker compose logs -f laravel.test --tail=100

# Create manual backup
docker compose exec -T pgsql pg_dump -U mbfd_user mbfd_hub > backup.sql
```

---

**Document Status**: Updated  
**Last Updated**: 2026-02-17  
**Next Review**: 2026-03-17 (30 days)  
**Maintained By**: Development Team
