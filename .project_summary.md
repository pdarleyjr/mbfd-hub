# MBFD Support Hub - Comprehensive Project Summary

**Generated**: 2026-02-09  
**Last Updated**: 2026-02-13  
**Status**: Production Ready  
**Environment**: VPS 145.223.73.170 (Hostinger Docker VPS)  
**Domain**: https://support.darleyplex.com

⚠️ **IMPORTANT**: This file contains PROJECT STRUCTURE and SECRET LOCATIONS ONLY (no actual credentials). Git-ignored for safety.

---

## 1. Overall Architecture Summary

### Technology Stack

**Backend**:
- **Framework**: Laravel 11.31
- **Admin Panel**: Filament v3.2
- **Real-time UI**: Livewire v3
- **PHP**: 8.2+
- **Database**: PostgreSQL 18-alpine
- **Queue**: Database-backed
- **Cache**: Database-backed
- **Error Tracking**: Sentry
- **PDF Generation**: barryvdh/laravel-dompdf

**Frontend**:
- **Admin Panel**: Filament (Blade + Livewire + Alpine.js)
- **Daily Checkout SPA**: React 18 + TypeScript + Vite
- **Forms Hub**: React 18 + TypeScript
- **Styling**: Tailwind CSS
- **PWA**: Service Worker + Web App Manifest

**Infrastructure**:
- **Containerization**: Docker Compose
- **Web Server**: Laravel Sail (PHP-FPM + nginx)
- **Reverse Proxy**: Cloudflare CDN (proxies support.darleyplex.com)
- **CI/CD**: GitHub Actions
- **Version Control**: GitHub (private repository)

### Docker Topology

```yaml
services:
  laravel.test:
    image: sail-8.5/app
    ports:
      - 80:80 (HTTP)
      - 127.0.0.1:5173:5173 (Vite HMR)
    depends_on: pgsql
    volumes:
      - .:/var/www/html

  pgsql:
    image: postgres:18-alpine
    ports:
      - 127.0.0.1:5432:5432 (BOUND TO LOCALHOST ONLY - Security Hardened)
    volumes:
      - sail-pgsql:/var/lib/postgresql

  baserow:
    image: baserow/baserow:latest
    ports:
      - 127.0.0.1:8082:80 (BOUND TO LOCALHOST ONLY)
    volumes:
      - baserow_data:/baserow/data
```

**Network**: Bridge network `sail`  
**Volumes**: `sail-pgsql` (persistent PostgreSQL data), `baserow_data` (Baserow data)

### Cloudflare Integration

- **DNS**: A record for support.darleyplex.com → 145.223.73.170
- **CDN**: Proxied through Cloudflare (orange cloud)
- **SSL**: Cloudflare Flexible SSL
- **Worker**: `mbfd-support-ai.pdarleyjr.workers.dev` (AI features)
- **Cache Purging**: Automated via deployment script

---

## 2. Executive Technical Status

### Application State: ✅ PRODUCTION READY

All critical features are deployed and operational:

#### ✅ Core Features (Completed)
- Fire apparatus tracking and inspection system
- Capital projects management (budget, milestones, AI tracking)
- Under-25k projects tracking
- Shop work orders and maintenance tracking
- **Station Inventory V2** (`/station-inventory-v2`) - NEW (Feb 2026) - PIN-gated on-hand counts with low-stock alerts
- Station Inventory V1 (preserved for audit/PDF) - Original submission-based system
- Single gas meters tracking with expiration alerts
- Uniform inventory management
- Todo/task management system with Kanban board
- **Daily Checkout React SPA** (`/daily`) - Offline-capable PWA
- **Forms Hub** (`/forms-hub`) - Centralized form submission portal with Big Ticket Item Request
- Equipment allocation and inventory management
- **Training Division Panel** (`/training`) - Separate Filament panel for Training Division
- **Real-time Chat** (`/admin/chatify`, `/training/chatify`) - Chatify + Laravel Reverb WebSocket messaging

#### ✅ Training Division Panel (Completed 2026-02-09)

A dedicated Filament v3 panel with independent authentication and role-based access control.

**Access URLs**:
- **Panel**: https://support.darleyplex.com/training
- **Login**: https://support.darleyplex.com/training/login

**Features**:
- Separate authentication from admin panel
- Independent navigation and dashboard
- Training-specific resources and workflows
- Dynamic navigation items linked to external sources
- Integration with Baserow for data management

**Resources**:
- **Training Todo** - Task management for training activities
- **External Sources** - Configure external data sources (Baserow instances)
- **External Nav Items** - Create dynamic navigation to embedded Baserow views

**File Structure**:
- `app/Filament/Training/` - Training panel implementation
  - `Pages/Dashboard.php` - Training panel dashboard
  - `Pages/ExternalNavItemViewer.php` - Iframe viewer for Baserow
  - `Resources/TrainingTodoResource.php` - Training task management
  - `Resources/ExternalSourceResource.php` - External source config
  - `Resources/ExternalNavItemResource.php` - Dynamic navigation config
  - `Support/DynamicNavigation.php` - Navigation item loader
  - `Widgets/TrainingTodoWidget.php` - Dashboard widget
- `app/Models/ExternalSource.php` - External data source model
- `app/Models/ExternalNavItem.php` - Navigation item model
- `app/Models/Training/` - Training-specific models

**Database Tables**:
- `external_sources` - Stores Baserow instance configurations
- `external_nav_items` - Dynamic navigation items with role permissions
- `training_todos` - Training division tasks

**Roles & Permissions**:
- `training_admin` - Full access to Training panel
- `training_viewer` - Read-only access to Training panel
- `training.access` - Required permission to access panel

**Authorization**:
Users must have the `training.access` permission (via `training_admin` or `training_viewer` role) to access the Training panel.

#### ✅ Baserow Integration (Completed 2026-02-09, Users Provisioned 2026-02-11)

Seamless integration with Baserow for external data management and visualization.

**Access URL**: https://baserow.support.darleyplex.com

**Baserow User Accounts** (provisioned 2026-02-11):

| User | Email | Workspace | Role |
|------|-------|-----------|------|
| Miguel Anchia | MiguelAnchia@miamibeachfl.gov | Support Services | Admin |
| Richard Quintela | RichardQuintela@miamibeachfl.gov | Support Services | Admin |
| Peter Darley | PeterDarley@miamibeachfl.gov | Support Services | Admin |
| Grecia Trabanino | GreciaTrabanino@miamibeachfl.gov | Support Services | Admin |
| Gerald DeYoung | geralddeyoung@miamibeachfl.gov | Support Services | Member |
| Daniel Gato | danielgato@miamibeachfl.gov | Training | Admin |
| Victor White | victorwhite@miamibeachfl.gov | Training | Admin |
| Claudio Navas | ClaudioNavas@miamibeachfl.gov | Training | Admin |
| Michael Sica | michaelsica@miamibeachfl.gov | Training | Admin |

**Settings**: New signups disabled, workspace creation disabled. Each user only sees their assigned workspace.

**Purpose**:
- Replace Excel workflows with web-based database management
- Embed Baserow views directly in Training panel navigation
- Enable collaborative data management for training resources

**Workflow**:
1. **Import Data**: Upload Excel files to Baserow or create tables from scratch
2. **Create Views**: Build Grid, Kanban, Form, or Gallery views in Baserow
3. **Share View**: Enable public sharing and copy shared view URL
4. **Add to MBFD Hub**:
   - Navigate to Training → External Nav Items
   - Create new nav item with Baserow shared URL
   - Configure label, division, type (iframe), and role permissions
   - Nav item appears in Training panel navigation

**Models**:
- [`ExternalSource`](app/Models/ExternalSource.php) - Baserow instance metadata
  - Base URL, authentication token, description
  - Type: 'baserow', 'airtable', 'other'
  - Encrypted token storage
- [`ExternalNavItem`](app/Models/ExternalNavItem.php) - Dynamic navigation items
  - Label, URL, division, type (link/iframe)
  - Role-based access control
  - Open in new tab option
  - Dynamic loading via DynamicNavigation trait

**Security**:
- Tokens encrypted at rest in database
- HTTPS-only connections
- Role-based access control on nav items
- Support for password-protected Baserow views
- CSRF protection on API endpoints

**Baserow Service**:
- Local Baserow instance running on port 8082
- Accessible via `http://localhost:8082` from within Docker network
- Persistent data storage in `baserow_data` volume
- Can be used as alternative to cloud-hosted Baserow (see [`docs/BASEROW_SELF_HOSTING.md`](docs/BASEROW_SELF_HOSTING.md))

**Documentation**:
- [`docs/BASEROW_INTEGRATION.md`](docs/BASEROW_INTEGRATION.md) - Integration guide
- [`docs/BASEROW_SELF_HOSTING.md`](docs/BASEROW_SELF_HOSTING.md) - Self-hosting setup
- [`docs/TRAINING_PANEL.md`](docs/TRAINING_PANEL.md) - Training panel overview

#### ✅ Advanced Features (Completed)
- Real-time web push notifications (VAPID-based)
- Filament dashboard with custom widgets
- Role-based access control (Spatie Permissions)
- API endpoints for React SPA integration
- Offline support with localStorage fallback
- PDF generation for reports (DomPDF)
- AI-powered project analysis (Cloudflare Workers AI)
- CSV import system for legacy data
- Multi-station support with cross-references

#### ✅ Integrations (Operational)
- **Sentry**: Error tracking for both backend (Laravel) and frontend (React)
- **Cloudflare Workers AI**: AI-driven project insights
- **GitHub Actions**: Automated CI/CD pipeline (fixed 2026-02-03)
- **Web Push Notifications**: Browser push via Service Worker
- **VAPID Keys**: Web push authentication configured

---

## 3. Current Known Issues + Fix Locations

### ✅ ALL CRITICAL ISSUES RESOLVED (as of 2026-02-03)

#### Issue 1: PDF Class Not Found ✅ FIXED (2026-02-03 17:37 EST)
- **Error**: `Class "Illuminate\Support\Facades\PDF" not found`
- **Root Cause**: Incorrect facade import in StationInventoryController.php:10
- **Fix**: Changed from `use Illuminate\Support\Facades\PDF;` to `use Barryvdh\DomPDF\Facade\Pdf;`
- **Files Modified**:
  - app/Http/Controllers/Api/StationInventoryController.php:10 (import)
  - app/Http/Controllers/Api/StationInventoryController.php:135 (usage)

#### Issue 2: HTTP 500 - Fire Apparatus Tab ✅ FIXED
- **Error**: NULL designation causing collection filter crash
- **Root Cause**: app/Filament/Resources/StationResource.php filtering on nullable `designation` field
- **Fix**: Added null check: `->when(fn($record) => $record->designation)`
- **File**: app/Filament/Resources/StationResource.php:180
- **Fixed**: 2026-01-29

#### Issue 3: HTTP 500 - Single Gas Meters Relation Manager ✅ FIXED
- **Error**: Missing `daysUntilExpiration()` method
- **Root Cause**: Relation manager calling undefined method
- **Fix**: Added method to app/Models/SingleGasMeter.php:45
- **Fixed**: 2026-02-02

#### Issue 4: CI/CD Pipeline Failures ✅ FIXED
- **Error**: PostgreSQL schema permissions + missing PDF package
- **Root Cause 1**: Database name mismatch (phpunit.xml used `testing`, CI used `mbfd_test`)
- **Root Cause 2**: `barryvdh/laravel-dompdf` package missing from composer.json
- **Fix 1**: Updated .github/workflows/ci.yml:60 with explicit permissions
- **Fix 2**: Added PDF package to composer.json:11
- **Fixed**: 2026-02-03

#### Issue 5: Vite MIME Type Errors (/daily) ✅ FIXED
- **Error**: `Refused to execute script... MIME type ('text/html')`
- **Root Cause**: Vite manifest pointing to dev server instead of built assets
- **Fix**: Ran `npm run build` in resources/js/daily-checkout/
- **Fixed**: 2026-01-30

#### Issue 6: API JSON Parse Errors ✅ FIXED
- **Error**: `Unexpected token '<' at position 0` (HTML error page instead of JSON)
- **Root Cause**: Missing CSRF token + missing `Accept: application/json` header
- **Fix**: Added headers to all API calls in resources/js/daily-checkout/src/utils/api.ts:12
- **Fixed**: 2026-01-31

### ⚠️ Minor Known Issues (Non-Blocking)

- **WebSocket via Cloudflare**: If Cloudflare proxy (orange cloud) has WebSockets disabled, the WS handshake may fail. Verify Cloudflare dashboard → Network → WebSockets is ON.
- **Reverb process persistence**: Reverb runs as a foreground process (no supervisor). If the container restarts, Reverb must be manually restarted or added to the entrypoint script.

---

## 4. Inventory of Integrations

### Sentry Error Tracking
- **Backend DSN**: Configured in `.env` as `SENTRY_LARAVEL_DSN`
- **Frontend DSN**: Configured in `.env` as `VITE_SENTRY_DSN`
- **Organization**: mbfd
- **Projects**: `support-backend`, `support-frontend`
- **Auth Token Location**: `.env` (`SENTRY_AUTH_TOKEN`)
- **Features**: Error tracking, performance monitoring, source maps

### Cloudflare
- **Account ID**: Stored in `.env` (`CLOUDFLARE_ACCOUNT_ID`)
- **API Token**: Stored in `.env` (`CLOUDFLARE_API_TOKEN`)
- **Zone ID**: Deployment script env variable
- **Worker**: `https://mbfd-support-ai.pdarleyjr.workers.dev`
  - **Purpose**: AI-powered project analysis using Cloudflare Workers AI
  - **Model**: `@cf/meta/llama-3-8b-instruct`
  - **Deployment**: Managed via cloudflare-worker/wrangler.toml
- **Features**: CDN, SSL, DNS, AI inference

### Web Push Notifications
- **Package**: `laravel-notification-channels/webpush`
- **VAPID Keys**: Stored in `.env`
  - `VAPID_PUBLIC_KEY` (exposed to client)
  - `VAPID_PRIVATE_KEY` (server-only)
  - `VAPID_SUBJECT` (mailto: email)
- **Service Worker**: public/sw.js
- **Push Widget**: resources/views/filament/widgets/push-notification-widget.blade.php
- **API Endpoints**: `/api/push-subscriptions`, `/api/push/test`
- **Documentation**: docs/NOTIFICATIONS_PLAYBOOK.md

### Real-time Chat (Chatify + Laravel Reverb)
- **Package**: `munafio/chatify` with `monzer/filament-chatify-integration`
- **WebSocket Server**: Laravel Reverb (runs inside Laravel container on port 8080)
- **Nginx Proxy**: `/app/` → `127.0.0.1:8090` (WebSocket upgrade), `/apps/` → `127.0.0.1:8090` (REST API)
- **Client**: Pusher JS connecting to `wss://support.darleyplex.com/app/<REVERB_APP_KEY>`
- **Config Files**: `config/chatify.php`, `config/broadcasting.php`, `config/reverb.php`
- **Chatify Views**: `resources/views/vendor/Chatify/` (published + customized as partials for Filament embedding)
- **CSS Overrides**: `public/css/chatify-fixes.css` (scoped layout fixes)
- **Documentation**: `docs/CHATIFY_REALTIME_TROUBLESHOOTING.md`, `docs/CHATIFY_UI_FIX.md`

### GitHub Actions CI/CD
- **Workflow**: .github/workflows/ci.yml
- **Triggers**: Push to main, pull requests
- **Steps**:
  1. Checkout code
  2. Setup PHP 8.2
  3. Install Composer dependencies
  4. Setup PostgreSQL service
  5. Run database migrations
  6. Run PHPUnit tests
  7. Upload Sentry source maps (on main push)
- **Secrets Required**: `SENTRY_AUTH_TOKEN`

---

## 5. Secrets Inventory (BY NAME AND LOCATION ONLY)

⚠️ **NO ACTUAL VALUES ARE STORED IN THIS DOCUMENT**

For detailed rotation procedures, see SECRETS_INVENTORY.md

### Database Credentials
| Secret | Location | Purpose | Priority |
|--------|----------|---------|----------|
| `DB_HOST` | `.env` | Database hostname | Config |
| `DB_PORT` | `.env` | Database port | Config |
| `DB_DATABASE` | `.env` | Database name | Config |
| `DB_USERNAME` | `.env` | Database user | P0 - Critical |
| `DB_PASSWORD` | `.env` | Database password | P0 - Critical |

### Application Secrets
| Secret | Location | Purpose | Priority |
|--------|----------|---------|----------|
| `APP_KEY` | `.env` | Laravel encryption key | P0 - Critical |
| `APP_NAME` | `.env` | Application name | Config |
| `APP_ENV` | `.env` | Environment (production) | Config |
| `APP_DEBUG` | `.env` | Debug mode (false in prod) | Config |

### API Keys & Tokens
| Secret | Location | Purpose | Priority |
|--------|----------|---------|----------|
| `GITHUB_TOKEN` | `.env` | GitHub API access | P1 - High |
| `CLOUDFLARE_API_TOKEN` | `.env` | Cloudflare API | P1 - High |
| `CLOUDFLARE_ACCOUNT_ID` | `.env` | Cloudflare account | P1 - High |
| `CLOUDFLARE_ZONE_ID` | Deployment scripts | Cache purging | P1 - High |
| `CLOUDFLARE_WORKER_API_SECRET` | `.env` | Worker authentication | P2 - Medium |

### Error Tracking
| Secret | Location | Purpose | Priority |
|--------|----------|---------|----------|
| `SENTRY_LARAVEL_DSN` | `.env` | Backend error tracking | P2 - Medium |
| `VITE_SENTRY_DSN` | `.env` | Frontend error tracking | P2 - Medium |
| `SENTRY_AUTH_TOKEN` | `.env`, GitHub Secrets | Source map uploads | P2 - Medium |

### Push Notifications
| Secret | Location | Purpose | Priority |
|--------|----------|---------|----------|
| `VAPID_PUBLIC_KEY` | `.env` | Web push (public) | P2 - Medium |
| `VAPID_PRIVATE_KEY` | `.env` | Web push (private) | P2 - Medium |
| `VAPID_SUBJECT` | `.env` | VAPID subject email | P2 - Medium |

### Rotation Status
- **Last Updated**: 2026-02-09
- **Next Rotation Due**: 2026-03-09 (30 days from security incident)
- **Rotation Guide**: SECRETS_INVENTORY.md#rotation-workflow

---

## 6. How to Deploy

### Prerequisites
- SSH access to VPS: `ssh root@145.223.73.170`
- Ensure `.env` file is configured on VPS
- Cloudflare API token set in environment

### Deployment Steps

#### Option A: Automated Deployment (Recommended)

```bash
# SSH into VPS
ssh root@145.223.73.170

# Run deployment script
cd /root/mbfd-hub
./scripts/deploy.sh
```

**Script Actions** (scripts/deploy.sh):
1. Creates database backup in `backups/`
2. Pulls latest code from `origin/main`
3. Rebuilds Docker containers
4. Runs Laravel migrations
5. Clears & rebuilds caches (config, routes, views)
6. Builds Daily Checkout frontend
7. Purges Cloudflare cache
8. Runs smoke tests

#### Option B: Manual Deployment

```bash
# 1. SSH into VPS
ssh root@145.223.73.170
cd /root/mbfd-hub

# 2. Backup database
mkdir -p backups
docker compose exec -T pgsql pg_dump -U mbfd_user mbfd_hub > "backups/manual_$(date +%Y%m%d_%H%M%S).sql"

# 3. Pull latest code
git fetch origin
git reset --hard origin/main
git clean -fd

# 4. Rebuild containers
docker compose up -d --build

# 5. Run Laravel commands
docker compose exec -T laravel.test php artisan migrate --force
docker compose exec -T laravel.test php artisan optimize:clear
docker compose exec -T laravel.test php artisan config:cache
docker compose exec -T laravel.test php artisan route:cache
docker compose exec -T laravel.test php artisan view:cache
docker compose exec -T laravel.test php artisan filament:clear-cached-components

# 6. Build Daily Checkout frontend
cd resources/js/daily-checkout
npm ci
npm run build
cd /root/mbfd-hub

# 7. Purge Cloudflare cache (optional)
./scripts/purge-cloudflare.sh

# 8. Verify deployment
curl -sf https://support.darleyplex.com/__version | jq .
curl -sf https://support.darleyplex.com/daily/ -o /dev/null && echo "Success"
```

### Post-Deployment Verification

1. **Check Application Health**:
   - Visit https://support.darleyplex.com/admin
   - Login and verify dashboard loads
   - Check that all tabs load without errors

2. **Verify Daily Checkout SPA**:
   - Visit https://support.darleyplex.com/daily
   - Verify React app loads
   - Test offline functionality
   - Test form submission

3. **Check Logs**:
   ```bash
   # Application logs
   docker compose logs -f laravel.test --tail=50
   
   # Database logs
   docker compose logs -f pgsql --tail=50
   ```

---

## 7. How to Rollback

### Automatic Rollback Script

```bash
# SSH into VPS
ssh root@145.223.73.170
cd /root/mbfd-hub

# Rollback to previous Git tag
./scripts/rollback.sh <tag-name> [backup-file]

# Example: Rollback to v1 tag with database restore
./scripts/rollback.sh v1-pre-daily-checkout backups/mbfd_hub_20260203_120000.sql
```

### Manual Rollback Steps

```bash
# 1. Identify last working commit
git log --oneline -10

# 2. Backup current state (just in case)
git branch backup-$(date +%Y%m%d_%H%M%S)

# 3. Revert to last working commit
git checkout <commit-hash>

# 4. Restore database from backup
BACKUP_FILE="backups/mbfd_hub_20260203_120000.sql"
docker compose exec -T pgsql psql -U mbfd_user mbfd_hub < "$BACKUP_FILE"

# 5. Restart application
docker compose restart laravel.test

# 6. Clear caches
docker compose exec laravel.test php artisan optimize:clear

# 7. Verify rollback
curl -sf https://support.darleyplex.com/admin
```

### Database Rollback Only

```bash
# List available backups
ls -lh /root/mbfd-hub/backups/

# Restore specific backup
docker compose exec -T pgsql psql -U mbfd_user mbfd_hub < backups/mbfd_hub_YYYYMMDD_HHMMSS.sql

# Restart app to pick up changes
docker compose restart laravel.test
```

---

## 8. Links to Key Documentation

### Project Documentation (in repo)

| Document | Path | Purpose |
|----------|------|---------|
| **Main README** | README.md | Laravel framework overview |
| **Training Panel** | docs/TRAINING_PANEL.md | Training division panel guide |
| **Baserow Integration** | docs/BASEROW_INTEGRATION.md | Baserow embedding workflow |
| **Baserow Self-Hosting** | docs/BASEROW_SELF_HOSTING.md | Local Baserow setup |
| **Notifications Guide** | docs/NOTIFICATIONS_PLAYBOOK.md | Web push notifications setup |
| **CI/CD Diagnostics** | docs/CI_DIAGNOSTIC_ANALYSIS.md | Pipeline troubleshooting |
| **Forms Hub Implementation** | docs/FORMS_HUB_IMPLEMENTATION.md | React forms app guide |
| **Daily Route Fix** | docs/DAILY_ROUTE_FIX.md | SPA routing resolution |
| **Station Relationships** | docs/STATION_RELATIONSHIPS.md | Data model linkages |
| **Settings Page Migration** | docs/SETTINGS_PAGE_MIGRATION.md | Filament 3 upgrade |
| **Capital Projects Enhancements** | docs/CAPITAL_PROJECTS_ENHANCEMENTS.md | AI tracking features |
| **Relation Manager Fixes** | docs/RELATION_MANAGER_FIXES.md | HTTP 500 resolutions |
| **Todos Mobile UX** | docs/TODOS_MOBILE_UX.md | Mobile optimization |
| **Checkout Reuse Map** | docs/CHECKOUT_REUSE_MAP.md | Component architecture |
| **Chatify Troubleshooting** | docs/CHATIFY_REALTIME_TROUBLESHOOTING.md | WebSocket + Chatify fixes |
| **Chatify UI Fix** | docs/CHATIFY_UI_FIX.md | Composer visibility CSS |
| **Baserow User Provisioning** | docs/BASEROW_USER_PROVISIONING.md | User setup guide |

### Security & Operations

| Document | Path | Purpose |
|----------|------|---------|
| **Secrets Inventory** | SECRETS_INVENTORY.md | Credentials rotation guide |
| **Security Incident Report** | SECURITY_INCIDENT_REPORT_2026_02_02.md | Malware cleanup |
| **Security Hardening** | SECURITY_HARDENING_APPLIED.md | Applied security measures |

### Deployment & Implementation

| Document | Path | Purpose |
|----------|------|---------|
| **Deploy Manual Steps** | deploy_manual_steps.md | Step-by-step deployment |
| **Single Gas Meters Guide** | SINGLE_GAS_METERS_DEPLOYMENT_GUIDE.md | Feature deployment |
| **Single Gas Meters Complete** | SINGLE_GAS_METERS_DEPLOYMENT_COMPLETE.md | Deployment summary |
| **Final Deployment Report** | FINAL_DEPLOYMENT_REPORT.md | Production rollout |
| **Cloudflare Worker Deployment** | cloudflare-worker/DEPLOYMENT.md | AI worker setup |

### Screenshots

| Screenshot | Path | Shows |
|------------|------|-------|
| Daily Checkout | screenshots/daily-page.png | React SPA interface |
| Todos Kanban | screenshots/kanban-board.png | Task management |
| Login Screen | screenshots/login-before.png | Authentication |
| Deployment Status | screenshots/deployment-status.png | CI/CD pipeline |

---

## 9. Common Maintenance Tasks

### Clear All Caches
```bash
docker compose exec laravel.test php artisan optimize:clear
```

###Regenerate Caches
```bash
docker compose exec laravel.test php artisan config:cache
docker compose exec laravel.test php artisan route:cache
docker compose exec laravel.test php artisan view:cache
```

### Check System Health
```bash
# Application logs
docker compose logs -f laravel.test --tail=100

# Database logs
docker compose logs -f pgsql --tail=50

# Check running processes
docker compose ps

# Check disk usage
df -h

# Check memory usage
free -h
```

### Database Maintenance
```bash
# Create manual backup
docker compose exec -T pgsql pg_dump -U mbfd_user mbfd_hub > backup.sql

# Check database size
docker compose exec pgsql psql -U mbfd_user mbfd_hub -c "SELECT pg_size_pretty(pg_database_size('mbfd_hub'));"
```

---

## 10. Security Hardening Applied

For full details, see SECURITY_HARDENING_APPLIED.md

### Implemented Protections

1. **PostgreSQL Port Restriction**:
   - Changed from `0.0.0.0:5432` to `127.0.0.1:5432`
   - Database only accessible from localhost
   - Prevents external connection attempts

2. **Malware Removal**:
   - Cryptomining malware eliminated (February 2, 2026)
   - 70-day infection resolved
   - System performance restored

3. **Container Security**:
   - Using official PostgreSQL 18-alpine image
   - Regular image updates scheduled
   - Docker security scanning enabled

4. **Application Security**:
   - Laravel security best practices applied
   - CSRF protection enabled
   - SQL injection prevention (Eloquent ORM)
   - XSS protection (Blade templating)

5. **Secret Management**:
   - All secrets in `.env` (gitignored)
   - Rotation schedule established
   - Secret locations documented

---

## 11. Debug Session Report (2026-02-08)

### Investigation Summary

**Date**: 2026-02-08  
**Investigator**: Kilo Code (Debug Mode)  
**Report**: Website loading investigation - **WEBSITE FULLY OPERATIONAL**

### Investigation Triggers

- User reported website not loading at support.darleyplex.com
- Requested thorough analysis of GitHub repo and Hostinger Docker VPS
- Required determination of root cause and fixes

### Diagnostic Tests Performed

#### 1. Docker Container Status ✅
```bash
# Checked running containers
docker compose ps

# Results:
# - mbfd-hub-laravel.test-1: Up 5 days (PHP-FPM + nginx on port 8080)
# - mbfd-hub-pgsql-1: Up 5 days (healthy PostgreSQL on port 5432)
```

#### 2. Database Connectivity ✅
```bash
# PostgreSQL health check
docker compose exec -T pgsql pg_isready -U mbfd_user

# Result: /var/run/postgresql:5432 - accepting connections ✅
```

#### 3. Website Accessibility Tests ✅
```bash
# Test 1: Local IP test (port 8080)
curl -I http://145.223.73.170:8080
# Result: HTTP/1.1 200 OK ✅

# Test 2: Domain test via Cloudflare CDN
curl -I https://support.darleyplex.com
# Result: HTTP/2 200 ✅

# Response Headers:
# server: nginx/1.24.0 (Ubuntu)
# date: Sun, 08 Feb 2026 20:11:39 GMT
# content-type: text/html; charset=utf-8
# host: support.darleyplex.com
# x-powered-by: PHP/8.5.2
# cache-control: no-cache, private
```

#### 4. Cloudflare Workers Status ✅
```bash
# Listed deployed workers
workers list

# Active Workers:
# - mbfd-support-ai (modified: 2026-01-26) - AI features
# - mbfd-github-proxy-production
# - mbfd-github-proxy
# - usar-ics212
# - pump-sim-instructor
# - iplcforms-v3, iplcforms-v3-preview
# - iplc-ai
```

#### 5. Laravel Application Logs ✅
```bash
# Checked logs for errors
docker compose logs laravel.test --tail=100

# Finding: Active requests being processed
# - Requests from ~18:00 to 20:11 UTC
# - Successful /, /livewire/update, and /sw.js calls
# - NO ERRORS in last logs ✅
```

#### 6. GitHub Repository Status ✅
```bash
# Checked latest commits
git log --oneline -5

# Recent commits (2026-02-03):
# - HTTP 500 fixes (PDF class, NULL designation)
# - CI/CD pipeline fixes
# - 0 open issues in repository ✅
```

### Root Cause Analysis

**Finding**: The website IS WORKING. No issues found.

**Possible reasons for "not loading" report**:
1. **Client-side browser issue**: Cache, cookies, or corrupted local storage
2. **Temporary network glitch**: Brief connectivity issue at time of report
3. **False report**: User error or miscommunication
4. **DNS propagation delay**: If DNS was recently changed
5. **Browser extension interference**: Ad blocker or security extension blocking requests

**NOT server-side issues**:
- ❌ Docker containers are running properly
- ❌ nginx is listening on all required ports
- ❌ Application is responding with HTTP 200
- ❌ Database connectivity is confirmed
- ❌ Cloudflare CDN proxy is active
- ❌ Laravel logs show no errors

### Recommendations

1. **For the user**: Clear browser cache and cookies, try incognito mode
2. **For troubleshooting**: Use `curl -I https://support.darleyplex.com` to verify from command line
3. **For monitoring**: Check Sentry dashboard for any client-side errors
4. **For verification**: Test from multiple devices/browsers before reporting issues

### System Health Summary

| Component | Status | Details |
|-----------|--------|---------|
| Docker - Laravel | ✅ Running | PHP-FPM + nginx, up 5 days |
| Docker - PostgreSQL | ✅ Healthy | Accepting connections, up 5 days |
| nginx | ✅ Operational | Version 1.24.0 (Ubuntu) |
| PHP | ✅ Operational | Version 8.5.2 |
| Application | ✅ Responsive | HTTP/2 200 from domain |
| Database | ✅ Connected | PostgreSQL 18-alpine |
| Cloudflare CDN | ✅ Proxied | Orange cloud active |
| Cloudflare Workers | ✅ Deployed | 8 workers including AI |
| GitHub CI/CD | ✅ Functional | Latest fixes applied Feb 3 |
| Sentry | ✅ Monitoring | Error tracking active |

### Conclusion

**Status**: ALL SYSTEMS OPERATIONAL  
**Action Required**: None  
**Next Review**: As needed or next reported issue

---

**Document Status**: Updated  
**Last Updated**: 2026-02-09  
**Last Debug Session**: 2026-02-08  
**Debug Mode**: Kilo Code  
**Result**: Website fully operational - No issues found

---

---

## 12. Recent Maintenance (2026-02-10)

### Chatify Contacts Fix ✅ RESOLVED

**Date**: 2026-02-10  
**Issue**: Chatify contacts not loading - users only seeing conversation history instead of all users  
**Root Cause**: Routes namespace in `config/chatify.php` pointing to vendor package controller instead of published custom controller

#### Problem Details

After implementing Training Dashboard notifications feature on 2026-02-09, Chatify contacts stopped displaying all users. Investigation revealed:

1. **API Endpoint Failure**: `/chatify/getContacts` returning HTTP 500 errors
2. **Error Message**: "Cannot redeclare class" fatal error
3. **Root Cause**: Namespace conflict between vendor controller and custom controller

The [`config/chatify.php`](config/chatify.php:1) had routes namespace still set to `'Chatify\Http\Controllers'` (vendor package) instead of `'App\Http\Controllers\vendor\Chatify'` (published custom controller).

#### Solution Applied

Modified [`config/chatify.php`](config/chatify.php:28):

```php
// BEFORE (pointing to vendor package - only showed conversation history)
'namespace' => env('CHATIFY_ROUTES_NAMESPACE', 'Chatify\Http\Controllers'),

// AFTER (pointing to custom controller - shows ALL users)
'namespace' => env('CHATIFY_ROUTES_NAMESPACE', 'App\Http\Controllers\vendor\Chatify'),
```

Also updated API routes namespace at line 33:
```php
'namespace' => env('CHATIFY_API_ROUTES_NAMESPACE', 'App\Http\Controllers\vendor\Chatify\Api'),
```

#### Custom Controller Logic

The custom [`MessagesController::getContacts()`](app/Http/Controllers/vendor/Chatify/MessagesController.php:1) method fetches ALL users except the authenticated user:

```php
$users = \App\Models\User::where('id', '!=', auth()->id())
    ->orderBy('name')
    ->get();
```

This differs from the vendor package which only returned users with existing conversation history.

#### Deployment

1. **Config Updated**: Modified `config/chatify.php` lines 28 and 33
2. **Deployed to VPS**: SCP'd file to `/root/mbfd-hub/config/chatify.php`
3. **Cache Cleared**: Ran `php artisan config:clear` and `php artisan cache:clear`
4. **Verified**: All 10 contacts now display correctly in both Training and Logistics panels

#### Testing Confirmation

- **Training Panel**: Tested at `/training/chatify` - All 10 users visible
- **Message Sending**: Successfully sent test message "Testing Chatify after namespace fix!"
- **Real-time Updates**: Pusher events firing correctly
- **Contact List Update**: Message preview showing immediately in sidebar
- **Logistics Panel**: Config shared between panels - both working correctly

#### Files Modified

- **Config**: `config/chatify.php` (lines 28, 33)
- **Git Commit**: `ae764a26` - "Fix Chatify contacts namespace: Use custom controller for all users"
- **Pushed to**: `origin/main` on GitHub

---

### Training Dashboard Notifications Feature ✅ COMPLETED (2026-02-09)

**Issue**: Push notification widget appearing twice in Training Dashboard body instead of Settings menu

**Problems Identified**:
1. `PushNotificationWidget` registered in Training panel widgets array
2. Training panel missing Settings page entirely
3. Notifications should be accessible via user menu → Settings (like Logistics panel)

**Solution Applied**:

1. **Removed Widget from Training Dashboard**:
   - Modified [`app/Providers/Filament/TrainingPanelProvider.php`](app/Providers/Filament/TrainingPanelProvider.php:1)
   - Removed `PushNotificationWidget::class` from `->widgets()` array

2. **Created Settings Page for Training Panel**:
   - Created [`app/Filament/Training/Pages/Settings.php`](app/Filament/Training/Pages/Settings.php:1)
   - Added navigation via `->userMenuItems()` in TrainingPanelProvider
   - Integrated `PushNotificationWidget` within Settings page
   - Route: `/training/settings`

3. **Preserved Logistics Admin Dashboard**:
   - No changes to [`app/Providers/Filament/AdminPanelProvider.php`](app/Providers/Filament/AdminPanelProvider.php:1)
   - Logistics Settings page already configured correctly
   - Only needed to remove duplicate widget from body

**Files Modified**:
- `app/Providers/Filament/TrainingPanelProvider.php`
- `app/Filament/Training/Pages/Settings.php` (new file)
- `resources/views/filament/training/pages/settings.blade.php` (new file)

**Testing Confirmation**:
- Training Dashboard: Widget removed from body ✅
- Training Settings: Accessible via user menu ✅
- Logistics Dashboard: Unaffected, working perfectly ✅
- Push notifications: Functional on both panels ✅

---

### Dashboard Errors & Station Column Fix ✅ RESOLVED (2026-02-10)

**Date**: 2026-02-10  
**Issues Reported**:
1. Capital Projects and other pages returning HTTP 500 errors
2. Many dashboard links/tabs not working
3. User `peterdarley@miamibeachfl.gov` being redirected to Training dashboard instead of Admin

#### Root Cause Analysis

**Issue 1: `stations.name` column does not exist**  
The `stations` table uses `station_number` as its display column, NOT `name`. Two Filament resources were referencing a non-existent `name` column in their station relationship selects and filters, causing HTTP 500 errors on Capital Projects and Under-25k Projects pages.

**Error from logs**:
```
SQLSTATE[42703]: Undefined column: 7 ERROR: column stations.name does not exist
LINE 1: select "stations"."name", "stations"."id" from "stations" or...
```

**Issue 2: Missing `ChFavorite.php` model in production**  
The Chatify integration's `ChFavorite` model existed in the local codebase but was not deployed to the VPS container, causing repeated `include(): Failed to open stream` errors.

**Issue 3: Panel routing (self-resolved)**  
User `peterdarley@miamibeachfl.gov` has roles `super_admin, admin` which correctly grants Admin panel access. The middleware [`RedirectTrainingUsers`](app/Http/Middleware/RedirectTrainingUsers.php:23) properly checks for `super_admin`/`admin` roles before redirecting. This issue self-resolved after cache clearing.

#### Fixes Applied

**Fix 1: [`CapitalProjectResource.php`](app/Filament/Resources/CapitalProjectResource.php)**  
Changed station relationship from `'name'` to `'station_number'`:
```php
// Line ~62 - Form Select
Forms\Components\Select::make('station_id')
    ->relationship('station', 'station_number')  // WAS: 'name'
    ->searchable()

// Line ~187 - Table Filter
Tables\Filters\SelectFilter::make('station')
    ->relationship('station', 'station_number')  // WAS: 'name'
    ->searchable()
```

**Fix 2: [`Under25kProjectResource.php`](app/Filament/Resources/Under25kProjectResource.php)**  
Same fix — changed station relationship from `'name'` to `'station_number'`:
```php
// Line ~57 - Form Select
Forms\Components\Select::make('station_id')
    ->relationship('station', 'station_number')  // WAS: 'name'

// Line ~220 - Table Filter
Tables\Filters\SelectFilter::make('station')
    ->relationship('station', 'station_number')  // WAS: 'name'
```

**Fix 3: Deployed [`ChFavorite.php`](app/Models/ChFavorite.php) to production container**

#### Critical Reference: Stations Table Schema

⚠️ **The `stations` table does NOT have a `name` column.** Any Filament resource referencing stations MUST use `station_number` as the display attribute.

```
Stations Table Columns:
  - id
  - station_number    ← USE THIS for display/relationship attributes
  - address
  - city
  - state
  - zip_code
  - captain_in_charge
  - phone
  - notes
  - created_at
  - updated_at
```

**Resources that correctly use `station_number`**:
- [`ApparatusResource.php`](app/Filament/Resources/ApparatusResource.php) — line 51 and 196
- [`StationInventorySubmissionResource.php`](app/Filament/Resources/StationInventorySubmissionResource.php) — line 115
- [`CapitalProjectResource.php`](app/Filament/Resources/CapitalProjectResource.php) — line 62 and 187 (FIXED)
- [`Under25kProjectResource.php`](app/Filament/Resources/Under25kProjectResource.php) — line 57 and 220 (FIXED)

#### Critical Reference: Panel Routing & User Roles

**Two Filament panels exist**:
- **Admin Panel** (`/admin`) — Default panel, marked with `->default()` in [`AdminPanelProvider.php`](app/Providers/Filament/AdminPanelProvider.php:40)
- **Training Panel** (`/training`) — Secondary panel in [`TrainingPanelProvider.php`](app/Providers/Filament/TrainingPanelProvider.php:32)

**Both panels share the same Login class**: [`App\Filament\Pages\Auth\Login`](app/Filament/Pages/Auth/Login.php)

**Role-based access logic** in [`User::canAccessPanel()`](app/Models/User.php:77):
- **Admin panel**: `super_admin`, `admin`, `training_admin`, or `training_viewer`
- **Training panel**: `super_admin`, `training_admin`, `training_viewer`, or `training.access` permission

**Middleware chain**:
- [`RedirectTrainingUsers`](app/Http/Middleware/RedirectTrainingUsers.php) — On Admin panel auth middleware. If user has `super_admin` or `admin` role → allow through. If user only has `training_admin`/`training_viewer` → redirect to `/training`.
- [`EnsureTrainingPanelAccess`](app/Http/Middleware/EnsureTrainingPanelAccess.php) — On Training panel auth middleware. Requires `super_admin`, `training_admin`, `training_viewer`, or `training.access` permission.

**Current role assignments** (as of 2026-02-10):
| Role | Count | Users |
|------|-------|-------|
| `super_admin` | 7 | All logistics + Gerald |
| `admin` | 7 | Same users (dual-roled) |
| `training_admin` | 4 | Daniel Gato, Victor White, Claudio Navas, Michael Sica |
| `training_viewer` | 0 | None assigned |

**Logistics admin users** (should always go to `/admin`):
- `miguelanchia@miamibeachfl.gov` — super_admin, admin
- `richardquintela@miamibeachfl.gov` — super_admin, admin
- `peterdarley@miamibeachfl.gov` — super_admin, admin
- `greciatrabanino@miamibeachfl.gov` — super_admin, admin
- `geralddeyoung@miamibeachfl.gov` — super_admin, admin

**Training admin users** (should go to `/training` when accessing `/admin`):
- `danielgato@miamibeachfl.gov` — training_admin
- `victorwhite@miamibeachfl.gov` — training_admin
- `claudionavas@miamibeachfl.gov` — training_admin
- `michaelsica@miamibeachfl.gov` — training_admin

#### Deployment Steps Used

```bash
# 1. SCP fixed files to VPS
scp -i ~/.ssh/id_ed25519_hpb_docker app/Filament/Resources/CapitalProjectResource.php root@145.223.73.170:/tmp/
scp -i ~/.ssh/id_ed25519_hpb_docker app/Filament/Resources/Under25kProjectResource.php root@145.223.73.170:/tmp/
scp -i ~/.ssh/id_ed25519_hpb_docker app/Models/ChFavorite.php root@145.223.73.170:/tmp/

# 2. Copy into Docker container
docker cp /tmp/CapitalProjectResource.php mbfd-hub-laravel.test-1:/var/www/html/app/Filament/Resources/
docker cp /tmp/Under25kProjectResource.php mbfd-hub-laravel.test-1:/var/www/html/app/Filament/Resources/
docker cp /tmp/ChFavorite.php mbfd-hub-laravel.test-1:/var/www/html/app/Models/

# 3. Clear and rebuild caches
docker exec mbfd-hub-laravel.test-1 php artisan optimize:clear
docker exec mbfd-hub-laravel.test-1 php artisan optimize
```

#### Diagnostic Script

A diagnostic script was created at [`scripts/diagnose_issues.php`](scripts/diagnose_issues.php) that checks:
- All user roles and panel access
- Panel registration status
- Role definitions and user counts
- Permission counts

Run it with:
```bash
docker exec mbfd-hub-laravel.test-1 php /var/www/html/scripts/diagnose_issues.php
```

---

---

## 13. Station Inventory V2 Implementation (2026-02-13)

### New Feature: PIN-Gated Station Inventory with Low-Stock Alerts ✅ COMPLETED

**Date**: 2026-02-13  
**Feature**: Complete redesign from submission-based to on-hand count system with real-time stock monitoring

#### Implementation Overview

A new station inventory system that replaces the forms-based submission workflow with real-time on-hand count management, featuring:

**Access Control**:
- PIN-gated access (default PIN: 1234 for all stations)
- Session-based validation
- Station-specific access control

**Inventory Management**:  
- Track on-hand quantities for 35 items across 5 categories
- PAR (Par Stock Level) system with 50% threshold alerts
- Low-stock detection and alerting
- Special Supply Request workflow for out-of-stock items

**Audit Trail**:
- Employee name + shift tracking for every update
- Transaction history with timestamps
- Full accountability for inventory changes

**Admin Dashboard**:
- Station Management resource with dedicated Inventory tab
- Real-time low-stock badges
- On-hand counts display with last update info
- Special request review and approval

#### Database Schema

**New Tables**:

1. **`station_pincodes`** - Station access PINs
   ```php
   - id
   - station_id (FK to stations)
   - pin_hash (bcrypt hashed)
   - is_active (boolean, default true)
   - created_at, updated_at
   ```

2. **`station_inventory_items`** - On-hand counts
   ```php
   - id
   - station_id (FK to stations)
   - item_key (e.g., 'garbage_liner_33gal')
   - quantity (current on-hand count)
   - par_quantity (replenishment level)
   - last_updated_at
   - updated_by (FK to users)
   - employee_name (submitter name)
   - shift (A/B/C)
   - created_at, updated_at
   ```

3. **`station_inventory_transactions`** - Audit log
   ```php
   - id
   - station_id (FK to stations)
   - item_key
   - quantity_before
   - quantity_after
   - transaction_type ('count_update', 'request_submitted', 'request_fulfilled')
   - employee_name
   - shift
   - notes
   - created_by (FK to users)
   - created_at, updated_at
   ```

4. **`station_special_requests`** - Out-of-stock workflow
   ```php
   - id
   - station_id (FK to stations)
   - item_key
   - requested_quantity
   - reason
   - status ('pending', 'approved', 'fulfilled', 'rejected')
   - employee_name
   - shift
   - reviewed_by (FK to users, nullable)
   - reviewed_at (nullable)
   - fulfillment_notes (nullable)
   - created_by (FK to users)
   - created_at, updated_at
   ```

#### File Structure

**Migrations**:
- [`database/migrations/2026_02_13_000001_create_station_pincodes_table.php`](database/migrations/2026_02_13_000001_create_station_pincodes_table.php)
- [`database/migrations/2026_02_13_000002_create_station_inventory_items_table.php`](database/migrations/2026_02_13_000002_create_station_inventory_items_table.php)
- [`database/migrations/2026_02_13_000003_create_station_inventory_transactions_table.php`](database/migrations/2026_02_13_000003_create_station_inventory_transactions_table.php)
- [`database/migrations/2026_02_13_000004_create_station_special_requests_table.php`](database/migrations/2026_02_13_000004_create_station_special_requests_table.php)
- [`database/migrations/2026_02_13_000005_seed_default_station_pincodes.php`](database/migrations/2026_02_13_000005_seed_default_station_pincodes.php)

**Models**:
- [`app/Models/StationPincode.php`](app/Models/StationPincode.php) - Station access PIN management
- [`app/Models/StationInventoryItem.php`](app/Models/StationInventoryItem.php) - On-hand count records
- [`app/Models/StationInventoryTransaction.php`](app/Models/StationInventoryTransaction.php) - Audit trail
- [`app/Models/StationSpecialRequest.php`](app/Models/StationSpecialRequest.php) - Special supply requests

**Controllers**:
- [`app/Http/Controllers/Api/StationInventoryV2Controller.php`](app/Http/Controllers/Api/StationInventoryV2Controller.php) - API endpoints for inventory management

**Livewire Components**:
- [`app/Livewire/StationInventoryV2.php`](app/Livewire/StationInventoryV2.php) - Main inventory management UI
- [`app/Livewire/StationPinGate.php`](app/Livewire/StationPinGate.php) - PIN authentication gate

**Filament Resources**:
- [`app/Filament/Resources/StationResource.php`](app/Filament/Resources/StationResource.php) - Updated with Inventory tab
- [`app/Filament/Resources/StationResource/RelationManagers/InventoryItemsRelationManager.php`](app/Filament/Resources/StationResource/RelationManagers/InventoryItemsRelationManager.php) - Admin inventory view

**Views**:
- [`resources/views/livewire/station-inventory-v2.blade.php`](resources/views/livewire/station-inventory-v2.blade.php) - Inventory form UI
- [`resources/views/livewire/station-pin-gate.blade.php`](resources/views/livewire/station-pin-gate.blade.php) - PIN entry modal

**Routes**:
- [`routes/web.php`](routes/web.php) - Added `/station-inventory-v2` route
- [`routes/api.php`](routes/api.php) - Added inventory v2 API endpoints

#### Feature Highlights

**Low-Stock Alerting**:
- 50% PAR threshold triggers "Low Stock" badge
- Color-coded indicators (green > 50%, yellow 25-50%, red < 25%)
- Admin dashboard displays low-stock items per station
- Automatic badge updates in Station resource Inventory tab

**Special Supply Request Workflow**:
1. Station user clicks "Request Special Supply" for out-of-stock item
2. Fills form: item, quantity, reason, employee name, shift
3. Request saved with status='pending'
4. Admin reviews in Station Inventory tab
5. Admin approves/rejects with notes
6. On fulfillment, quantity automatically updated

**Session Management**:
- PIN entry valid for 8 hours (SESSION_LIFETIME)
- Browser session stores station_id after successful PIN
- Middleware enforces station access for protected routes
- Session invalidation on browser close

#### Testing Confirmation

**✅ Verified**:
- PIN gate blocks unauthorized access (redirects to PIN entry)
- Successful PIN entry grants station access for session
- On-hand counts update on submission
- Low-stock badges display correctly (<50% PAR)
- Transaction history logs all changes with employee name + shift
- Special requests save with pending status
- Admin can view/approve requests in Filament
- Inventory tab displays current counts with last update timestamp

#### v1 Preservation

**Original Station Inventory** (preserved for historical audit):
- Table: `station_inventory_submissions`
- Resource: [`StationInventorySubmissionResource.php`](app/Filament/Resources/StationInventorySubmissionResource.php)
- PDF generation maintained for legacy reports
- No changes to existing v1 functionality
- Both systems coexist independently

---

## 14. Recent Bug Fixes (February 2026)

### Bug Fix: Station Inventory Form React Crash ✅ RESOLVED (2026-02-13)

**Date**: 2026-02-13  
**Issue**: Station Inventory form crashing in production with "Cannot read properties of undefined (reading 'map')"  
**Root Cause**: React component expecting `items` array from API but receiving undefined when no data exists

**Error Message**:
```
TypeError: Cannot read properties of undefined (reading 'map')
  at StationInventoryForm.jsx:145
```

**Fix Applied**:
- Added null/undefined checks with optional chaining in React component
- Changed `items.map()` to `items?.map()` throughout component
- Added default empty array fallback: `const items = data?.items ?? []`
- Prevented crash when API returns empty response

**Files Modified**:
- [`resources/js/forms-hub/src/components/StationInventoryForm.jsx`](resources/js/forms-hub/src/components/StationInventoryForm.jsx) (lines 120-155)

---

### Bug Fix: Chatify HTTP 500 Error ✅ RESOLVED (2026-02-13)

**Date**: 2026-02-13  
**Issue**: Chatify messaging throwing HTTP 500 errors, chat completely broken  
**Root Cause**: View file directory case mismatch - code looking for `Chatify` but filesystem had `chatify`

**Error Message**:
```
View [vendor.Chatify.pages.app] not found
Expected: resources/views/vendor/Chatify/pages/app.blade.php
Found: resources/views/vendor/chatify/pages/app.blade.php
```

**Fix Applied**:
- Renamed directory: `resources/views/vendor/chatify/` → `resources/views/vendor/Chatify/`
- Windows NTFS is case-insensitive but Laravel view loader is case-sensitive
- Deployed corrected directory structure to VPS (Linux case-sensitive filesystem)

**Files Modified**:
- Renamed directory structure (case correction only, no code changes)

**Testing Confirmation**:
- Chatify loads successfully at `/admin/chatify` and `/training/chatify`
- Real-time messaging functional via Laravel Reverb
- Message history displays correctly
- User list loads without errors

---

## 15. Chatify/Reverb Rescue & Baserow Provisioning (2026-02-11)

### Chatify Rescue — Root Causes & Fixes

**Problem**: `/admin/chatify` and `/training/chatify` were completely broken with multiple cascading errors: duplicate Alpine/Livewire instances, missing JS files, broken Filament sidebar/stores, and WebSocket 404s.

**Root Cause 1: Duplicate Alpine/Livewire** — [`resources/views/vendor/Chatify/pages/app.blade.php`](resources/views/vendor/Chatify/pages/app.blade.php) was a full `<!DOCTYPE html>` document. When `@include`d inside Filament's layout, it created a nested HTML document with duplicate Alpine, Livewire, and Filament scripts.  
**Fix**: Rewrote as a partial template (no `<html>`, `<head>`, `<body>` wrapper).

**Root Cause 2: chatify.js 404** — [`resources/views/vendor/Chatify/layouts/footerLinks.blade.php`](resources/views/vendor/Chatify/layouts/footerLinks.blade.php) referenced `chatify.js` which never existed; the actual file is [`public/js/chatify/code.js`](public/js/chatify/code.js).  
**Fix**: Updated reference to `code.js`.

**Root Cause 3: Broadcasting misconfiguration** — [`config/broadcasting.php`](config/broadcasting.php) reverb driver used the external hostname for server-side event publishing, routing through Cloudflare→Nginx→back instead of directly to local Reverb.  
**Fix**: Changed to use `REVERB_SERVER_HOST` (0.0.0.0:8080/http) for internal publishing.

**Files Modified**:
- `resources/views/vendor/Chatify/pages/app.blade.php` — Full HTML doc → partial
- `resources/views/vendor/Chatify/layouts/headLinks.blade.php` — Chatify-only assets, no Alpine/Livewire
- `resources/views/vendor/Chatify/layouts/footerLinks.blade.php` — Chatify-only scripts, chatify.js→code.js
- `config/broadcasting.php` — Server-side reverb driver → local host
- `.env` (on VPS only) — Removed duplicate VITE_REVERB_* entries

**Git Commits**: `35d6dd6a`, `5b22bbf3`, `a930a73a` on branch `rescue/chatify-recovery-2026-02-11`, merged to `main`.

### Baserow User Provisioning

9 users provisioned across 2 workspaces via Baserow REST API + direct DB password hashing for short passwords.

**Passwords** (same as MBFD Hub app passwords):
- Logistics users use their existing MBFD Hub passwords for Baserow
- Training users use their existing MBFD Hub passwords for Baserow
- Passwords stored in `.local/baserow_users.json` (git-ignored)

**Settings Applied**: Signups disabled, workspace creation disabled.

---

**Document Status**: Complete  
**Last Updated**: 2026-02-13  
**Next Review**: 2026-03-09 (30 days)  
**Maintained By**: Development Team

---

## RECENT UPDATES (2026-02-13)

### New Features
- **Station Inventory V2**: Complete redesign with PIN-gated access, on-hand counts, 50% PAR threshold alerts, special supply request workflow
- Full audit trail with employee name + shift tracking
- Admin dashboard with low-stock badges

### Bug Fixes
- Fixed Station Inventory form React crash (data mapping null/undefined)
- Fixed Chatify HTTP 500 error (view directory case mismatch)
